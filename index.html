<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026æ¹–å—çœè€ƒå†²åˆº (è§„åˆ’å®šåˆ¶ç‰ˆ)</title>
    <style>
        :root {
            --primary: #D32F2F; --primary-dark: #b71c1c; --secondary: #1976D2;
            --bg: #f5f7fa; --card: #ffffff; --text: #333333; --subtext: #666666;
            --success: #4CAF50; --warning: #FF9800; --process: #0288D1;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg); color: var(--text);
            margin: 0; padding: 0; padding-bottom: 100px;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- å¤´éƒ¨ --- */
        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; padding: 15px 20px 25px 20px;
            border-radius: 0 0 25px 25px; box-shadow: 0 4px 15px rgba(211, 47, 47, 0.3);
            position: relative;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .app-title { font-weight: 800; font-size: 1.1rem; }
        
        .btn-group { display: flex; gap: 8px; }
        .icon-btn {
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
            color: white; padding: 5px 10px; border-radius: 15px;
            font-size: 0.8rem; cursor: pointer; backdrop-filter: blur(5px);
        }

        .date-nav {
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(0,0,0,0.15); border-radius: 12px; padding: 10px;
            margin-bottom: 12px; backdrop-filter: blur(5px);
        }
        .nav-btn { background: none; border: none; color: white; font-size: 1.5rem; padding: 0 15px; cursor: pointer; opacity: 0.8; }
        .date-main { font-size: 1.2rem; font-weight: 700; }
        .date-sub { font-size: 0.8rem; opacity: 0.9; margin-top: 2px; }

        .progress-bar-bg { height: 6px; background: rgba(0,0,0,0.2); border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: #FFD700; width: 0%; transition: width 0.4s; }

        .back-today {
            position: absolute; bottom: -12px; left: 50%; transform: translateX(-50%);
            background: #FFD700; color: #b71c1c; padding: 5px 15px;
            border-radius: 20px; font-size: 0.75rem; font-weight: bold;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2); cursor: pointer; display: none; z-index: 10;
        }

        /* --- ä»»åŠ¡é¡¹æ ·å¼ --- */
        .task-list { padding: 0 15px; }
        .task-item {
            background: white; margin: 15px 0; padding: 16px;
            border-radius: 16px; display: flex; flex-direction: column;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03); transition: all 0.3s;
            border-left: 6px solid #ddd;
        }
        .task-item.in-progress { border-left-color: var(--process); background: #f0f9ff; }
        .task-item.completed { border-left-color: var(--success); background: #f9fff9; }
        
        .task-top-row { display: flex; align-items: flex-start; }
        .status-btn {
            width: 44px; height: 44px; border: 2px solid #ddd; border-radius: 12px;
            margin-right: 12px; flex-shrink: 0; display: flex; flex-direction: column;
            align-items: center; justify-content: center; cursor: pointer;
            font-size: 0.65rem; font-weight: bold; transition: all 0.2s;
            background: white; color: #999;
        }
        .task-item.in-progress .status-btn { border-color: var(--process); color: var(--process); }
        .task-item.completed .status-btn { background: var(--success); border-color: var(--success); color: white; }

        .task-main-info { flex: 1; }
        .task-ref-time { font-size: 0.75rem; color: #999; margin-bottom: 2px; display: block; }
        
        .task-input-title {
            width: 100%; border: none; background: transparent;
            font-size: 1rem; font-weight: 600; color: var(--text);
            padding: 2px 0; border-bottom: 1px dashed #eee; outline: none;
        }

        .time-badge-row { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
        .time-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; font-weight: bold; }
        .badge-start { background: #e3f2fd; color: #0277bd; }
        .badge-end { background: #e8f5e9; color: #2e7d32; }
        .badge-duration { background: #fff3e0; color: #ef6c00; border: 1px solid #ffe0b2; }

        .task-note-area {
            width: 100%; border: none; background: #f8f8f8;
            border-radius: 8px; padding: 10px; font-size: 0.85rem;
            color: #555; margin-top: 10px; resize: none; outline: none;
            box-sizing: border-box;
        }

        .phase-card {
            background: white; margin: 20px 15px 10px 15px; padding: 18px;
            border-radius: 16px; border-left: 5px solid var(--secondary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            display: flex; justify-content: space-between; align-items: center;
        }
        .phase-title { font-weight: 700; color: var(--secondary); font-size: 1.05rem; }
        .phase-desc { font-size: 0.85rem; color: var(--subtext); margin-top: 5px; }

        /* æ¨¡æ€æ¡†é€šç”¨ */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999; display: none; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal-card { background: white; width: 94%; max-width: 500px; height: 85vh; border-radius: 20px; overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .modal-body { flex: 1; overflow-y: auto; padding: 15px; }

        /* ç¼–è¾‘è§„åˆ’ä¸“ç”¨æ ·å¼ */
        .edit-phase-section { border: 1px solid #eee; border-radius: 12px; padding: 12px; margin-bottom: 15px; background: #fafafa; }
        .edit-phase-head { font-weight: bold; color: var(--secondary); margin-bottom: 8px; font-size: 0.9rem; }
        .edit-task-row { display: flex; gap: 5px; margin-bottom: 8px; align-items: center; }
        .edit-input { padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.8rem; }
        .btn-add { background: var(--success); color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 0.75rem; cursor: pointer; }
        .btn-del { background: #ff5252; color: white; border: none; padding: 5px 8px; border-radius: 4px; font-size: 0.75rem; cursor: pointer; }
        .save-bar { padding: 15px; background: white; border-top: 1px solid #eee; }
        .btn-main-save { width: 100%; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: bold; }

        .toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 12px 24px; border-radius: 25px; z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-top">
            <div class="app-title">âš–ï¸ çœè€ƒè®¡æ—¶ç¬”è®° Â· å®šåˆ¶ç‰ˆ</div>
            <div class="btn-group">
                <button class="icon-btn" onclick="openPlanModal()">ğŸ“ è§„åˆ’</button>
                <button class="icon-btn" onclick="openHistoryModal()">ğŸ“… è®°å½•</button>
                <button class="icon-btn" onclick="showSettings()">âš™ï¸ å¤‡ä»½</button>
            </div>
        </div>

        <div class="date-nav">
            <button class="nav-btn" onclick="changeDay(-1)">â€¹</button>
            <div style="text-align:center">
                <div class="date-main" id="headerDate">--æœˆ--æ—¥</div>
                <div class="date-sub" id="headerSub">--</div>
            </div>
            <button class="nav-btn" onclick="changeDay(1)">â€º</button>
        </div>
        
        <div class="progress-bar-bg"><div class="progress-fill" id="progressBar"></div></div>
        <div class="back-today" id="backTodayBtn" onclick="goToToday()">å›åˆ°ä»Šå¤©</div>
    </div>

    <div id="phaseContainer"></div>
    <div class="task-list" id="taskList"></div>

    <div class="modal-overlay" id="planModal">
        <div class="modal-card">
            <div class="modal-header">
                <span>ğŸ—“ï¸ é˜¶æ®µè§„åˆ’ä¸­å¿ƒ</span>
                <button style="border:none; background:none; font-size:1.5rem;" onclick="closeModal('planModal')">Ã—</button>
            </div>
            <div class="modal-body" id="planEditorBody">
                </div>
            <div class="save-bar">
                <button class="btn-main-save" onclick="saveAllPlans()">ğŸ’¾ ä¿å­˜å¹¶æ›´æ–°æ‰€æœ‰è®¡åˆ’</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="historyModal">
        <div class="modal-card">
            <div class="modal-header">
                <span>å¤‡è€ƒè¶³è¿¹</span>
                <button style="border:none; background:none; font-size:1.5rem;" onclick="closeModal('historyModal')">Ã—</button>
            </div>
            <div class="modal-body" id="historyContent"></div>
        </div>
    </div>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal-card" style="height: auto; padding: 20px;">
            <h3 style="margin-top:0">æ•°æ®ç®¡ç†</h3>
            <p style="font-size:0.85rem; color:#666;">å°†å¤‡ä»½åŒ…å«ï¼šè®¡æ—¶è®°å½•ã€å¿ƒå¾—ç¬”è®°ã€ä»¥åŠä½ çš„**è‡ªå®šä¹‰é˜¶æ®µè§„åˆ’**ã€‚</p>
            <button onclick="exportData()" style="width:100%; padding:12px; background:var(--secondary); color:white; border:none; border-radius:8px; margin-bottom:10px;">ğŸ“¤ å¯¼å‡ºå…¨é‡å¤‡ä»½ (.json)</button>
            <button onclick="document.getElementById('importFile').click()" style="width:100%; padding:12px; background:#eee; border:none; border-radius:8px;">ğŸ“¥ å¯¼å…¥æ¢å¤æ•°æ®</button>
            <input type="file" id="importFile" style="display:none" onchange="importData(this)">
            <button onclick="closeModal('settingsModal')" style="width:100%; margin-top:15px; border:none; background:none; color:#999;">å…³é—­</button>
        </div>
    </div>

    <div class="toast" id="toast">âœ… å·²æ›´æ–°</div>

    <script>
        // --- 1. åŸºç¡€é…ç½®ä¸é»˜è®¤è§„åˆ’ ---
        const EXAM_DATE = new Date('2026-03-14');
        const START_DATE = new Date('2026-01-01');
        let currentViewDate = new Date();

        // é»˜è®¤é…ç½®ï¼ˆå¦‚æœç”¨æˆ·æ²¡æœ‰è‡ªå®šä¹‰ï¼Œåˆ™åŠ è½½è¿™ä¸ªï¼‰
        const DEFAULT_PLAN_CONFIG = [
            { id: 0, title: "ğŸ›  Phase 0ï¼šæ•´å¤‡æœŸ", desc: "ç¯å¢ƒæ¸…ç†ã€ç‰©èµ„é‡‡è´­", range: [1, 1, 1, 10], tasks: [{t:"08:30",title:"é€šè§ˆè®¡åˆ’"},{t:"10:00",title:"ç‰©èµ„é‡‡è´­"},{t:"14:00",title:"ç¯å¢ƒæ¸…ç†"}] },
            { id: 1, title: "ğŸ— Phase 1ï¼šåŸºçŸ³æœŸ", desc: "ä¸»æ”»èµ„æ–™ã€æ•°é‡ä¸æ™¨è¯»", range: [1, 11, 2, 14], tasks: [{t:"07:30",title:"èµ·å±…å¯åŠ¨"},{t:"08:00",title:"æ™¨è¯»(æ¹˜æƒ…)"},{t:"08:30",title:"èµ„æ–™åˆ†æ"},{t:"10:45",title:"æ•°é‡å…³ç³»"},{t:"14:00",title:"è¨€è¯­åˆ¤æ–­"}] },
            { id: 2, title: "ğŸ§¨ Phase 2ï¼šæ˜¥èŠ‚æœŸ", desc: "2æœˆ17è¿‡å¹´ï¼Œå¼¹æ€§ä¿æŒæ‰‹æ„Ÿ", range: [2, 15, 2, 21], tasks: [{t:"09:00",title:"é˜²æ‰‹ç”Ÿè®­ç»ƒ"},{t:"14:00",title:"æ¹–å—å¸¸è¯†"}] },
            { id: 3, title: "ğŸš€ Phase 3ï¼šæé€ŸæœŸ", desc: "æ”¶å¿ƒã€å¼ºæ”»ä¸“é¡¹ã€ç”³è®ºæ‰‹å†™", range: [2, 22, 3, 7], tasks: [{t:"08:30",title:"ğŸ”´ å¼ºæ”»ä¸“é¡¹"},{t:"10:45",title:"ğŸ”µ è¾…ç»ƒä¸“é¡¹"},{t:"14:00",title:"ç”³è®ºæ‰‹å†™"}] },
            { id: 4, title: "ğŸ Phase 4ï¼šæ¨¡è€ƒæœŸ", desc: "å…¨çœŸæ¨¡è€ƒã€è€ƒåœºé€‚åº”", range: [3, 8, 3, 13], tasks: [{t:"09:00",title:"âš¡ å…¨çœŸæ¨¡è€ƒ"},{t:"14:00",title:"ç”³è®ºå¤ç›˜"},{t:"19:00",title:"æŠ¼é¢˜èƒŒè¯µ"}] }
        ];

        // --- 2. æ•°æ®å·¥å…· ---
        const getPlans = () => JSON.parse(localStorage.getItem('hunan_plan_config') || JSON.stringify(DEFAULT_PLAN_CONFIG));
        const formatDate = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        const timeToMins = s => { if(!s || !s.includes(':')) return 0; const [h,m]=s.split(':').map(Number); return h*60+m; };

        // --- 3. æ ¸å¿ƒï¼šè·å–å½“å‰æ—¥æœŸçš„é˜¶æ®µå’Œä»»åŠ¡ ---
        function getRawTasks(date) {
            const m = date.getMonth() + 1;
            const d = date.getDate();
            const plans = getPlans();
            
            // æŸ¥æ‰¾åŒ¹é…æ—¥æœŸçš„é˜¶æ®µ
            let found = plans.find(p => {
                const [sm, sd, em, ed] = p.range;
                const startVal = sm * 100 + sd;
                const endVal = em * 100 + ed;
                const currVal = m * 100 + d;
                return currVal >= startVal && currVal <= endVal;
            });

            return found || { title: "â³ éå¤‡è€ƒæœŸ", desc: "æš‚æ— å‚è€ƒè®¡åˆ’ã€‚", tasks: [] };
        }

        // --- 4. æ¸²æŸ“ä¸»é¡µé¢ ---
        function render() {
            const dateKey = formatDate(currentViewDate);
            const raw = getRawTasks(currentViewDate);
            
            document.getElementById('headerDate').innerText = `${currentViewDate.getMonth()+1}æœˆ${currentViewDate.getDate()}æ—¥`;
            const diff = Math.ceil((EXAM_DATE - currentViewDate)/86400000);
            document.getElementById('headerSub').innerText = dateKey === formatDate(new Date()) ? `è·çœè€ƒ ${diff} å¤©` : `å¾€æ—¥ç¬”è®°`;
            document.getElementById('backTodayBtn').style.display = (dateKey === formatDate(new Date())) ? 'none' : 'block';

            document.getElementById('phaseContainer').innerHTML = `
                <div class="phase-card">
                    <div>
                        <div class="phase-title">${raw.title}</div>
                        <div class="phase-desc">${raw.desc}</div>
                    </div>
                    <button class="btn-add" style="background:#eee; color:#666;" onclick="openPlanModal()">ä¿®æ”¹è§„åˆ’</button>
                </div>`;

            // åŠ è½½ç”¨æˆ·å½“å¤©çš„æ•°æ®
            const starts = JSON.parse(localStorage.getItem('hunan_start_times_' + dateKey) || '{}');
            const ends = JSON.parse(localStorage.getItem('hunan_actual_times_' + dateKey) || '{}');
            const done = JSON.parse(localStorage.getItem('hunan_exam_' + dateKey) || '[]');
            const notes = JSON.parse(localStorage.getItem('hunan_notes_' + dateKey) || '{}');
            const userTitles = JSON.parse(localStorage.getItem('hunan_actual_tasks_' + dateKey) || '{}');

            const listEl = document.getElementById('taskList');
            listEl.innerHTML = '';
            let lastEndTimeMins = 0;

            raw.tasks.forEach((t, i) => {
                const startTime = starts[i];
                const endTime = ends[i];
                const isDone = done.includes(i);
                const isInProgress = startTime && !endTime;
                const noteValue = notes[i] || '';
                const displayTitle = userTitles[i] || t.title;

                let durationText = "";
                if(startTime && endTime) {
                    const diff = timeToMins(endTime) - timeToMins(startTime);
                    durationText = diff > 0 ? `${diff}åˆ†é’Ÿ` : "è¯¯å·®";
                }

                let dynamicRef = (i > 0 && lastEndTimeMins > 0) ? `æ¥ç»­ä¸Šé¡¹` : t.t;
                if(endTime) lastEndTimeMins = timeToMins(endTime);

                listEl.innerHTML += `
                    <div class="task-item ${isDone ? 'completed' : (isInProgress ? 'in-progress' : '')}">
                        <div class="task-top-row">
                            <div class="status-btn" onclick="handleTimerClick(${i})">
                                <span>${isDone ? 'å®Œæˆ' : (isInProgress ? 'ç»“æŸ' : 'å¼€å§‹')}</span>
                            </div>
                            <div class="task-main-info">
                                <span class="task-ref-time">å‚è€ƒ: ${t.t} â†’ ${dynamicRef}</span>
                                <input type="text" class="task-input-title" id="title_${i}" 
                                    value="${displayTitle}" onchange="saveTaskField(${i}, 'title')">
                                <div class="time-badge-row">
                                    ${startTime ? `<span class="time-badge badge-start">å§‹ ${startTime}</span>` : ''}
                                    ${endTime ? `<span class="time-badge badge-end">ç»ˆ ${endTime}</span>` : ''}
                                    ${durationText ? `<span class="time-badge badge-duration">â±ï¸ ${durationText}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <textarea class="task-note-area" id="note_${i}" rows="2" 
                            placeholder="å†™ä¸‹å¿ƒå¾—..." onchange="saveTaskField(${i}, 'note')">${noteValue}</textarea>
                    </div>`;
            });
            document.getElementById('progressBar').style.width = (raw.tasks.length ? (done.length/raw.tasks.length*100) : 0) + '%';
        }

        // --- 5. è§„åˆ’ç¼–è¾‘å™¨é€»è¾‘ ---
        let editingPlans = [];

        function openPlanModal() {
            editingPlans = getPlans();
            renderPlanEditor();
            document.getElementById('planModal').classList.add('active');
        }

        function renderPlanEditor() {
            const container = document.getElementById('planEditorBody');
            container.innerHTML = editingPlans.map((p, pIdx) => `
                <div class="edit-phase-section">
                    <div class="edit-phase-head">é˜¶æ®µ ${pIdx}: <input type="text" value="${p.title}" onchange="editingPlans[${pIdx}].title=this.value" class="edit-input" style="width:70%"></div>
                    <div style="margin-bottom:10px">
                        <span style="font-size:0.75rem; color:#888;">èŒƒå›´: ${p.range[0]}/${p.range[1]} è‡³ ${p.range[2]}/${p.range[3]}</span>
                    </div>
                    <div id="edit-tasks-${pIdx}">
                        ${p.tasks.map((t, tIdx) => `
                            <div class="edit-task-row">
                                <input type="text" placeholder="æ—¶é—´" value="${t.t}" class="edit-input" style="width:50px" onchange="editingPlans[${pIdx}].tasks[${tIdx}].t=this.value">
                                <input type="text" placeholder="ä»»åŠ¡å" value="${t.title}" class="edit-input" style="flex:1" onchange="editingPlans[${pIdx}].tasks[${tIdx}].title=this.value">
                                <button class="btn-del" onclick="removeTask(${pIdx}, ${tIdx})">âœ•</button>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn-add" onclick="addTask(${pIdx})">+ æ·»åŠ æ¯æ—¥é»˜è®¤é¡¹</button>
                </div>
            `).join('');
        }

        function addTask(pIdx) {
            editingPlans[pIdx].tasks.push({ t: "09:00", title: "æ–°ä»»åŠ¡" });
            renderPlanEditor();
        }

        function removeTask(pIdx, tIdx) {
            editingPlans[pIdx].tasks.splice(tIdx, 1);
            renderPlanEditor();
        }

        function saveAllPlans() {
            localStorage.setItem('hunan_plan_config', JSON.stringify(editingPlans));
            showToast("è§„åˆ’æ›´æ–°æˆåŠŸï¼");
            closeModal('planModal');
            render();
        }

        // --- 6. è®¡æ—¶ä¸ç¬”è®°ä¸šåŠ¡é€»è¾‘ ---
        function handleTimerClick(idx) {
            const dateKey = formatDate(currentViewDate);
            let starts = JSON.parse(localStorage.getItem('hunan_start_times_' + dateKey) || '{}');
            let ends = JSON.parse(localStorage.getItem('hunan_actual_times_' + dateKey) || '{}');
            let done = JSON.parse(localStorage.getItem('hunan_exam_' + dateKey) || '[]');
            const now = new Date();
            const nowStr = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;

            if (!starts[idx]) {
                const t = prompt("å¼€å§‹æ—¶é—´:", nowStr);
                if (t !== null) starts[idx] = t || nowStr;
            } else if (starts[idx] && !ends[idx]) {
                const t = prompt("ç»“æŸæ—¶é—´:", nowStr);
                if (t !== null) { ends[idx] = t || nowStr; if(!done.includes(idx)) done.push(idx); }
            } else {
                if(confirm("é‡ç½®è®¡æ—¶ï¼Ÿ")) { delete starts[idx]; delete ends[idx]; done = done.filter(x => x !== idx); } else return;
            }
            localStorage.setItem('hunan_start_times_' + dateKey, JSON.stringify(starts));
            localStorage.setItem('hunan_actual_times_' + dateKey, JSON.stringify(ends));
            localStorage.setItem('hunan_exam_' + dateKey, JSON.stringify(done));
            render();
        }

        function saveTaskField(idx, type) {
            const dateKey = formatDate(currentViewDate);
            const key = type === 'title' ? 'hunan_actual_tasks_' : 'hunan_notes_';
            let data = JSON.parse(localStorage.getItem(key + dateKey) || '{}');
            data[idx] = document.getElementById(type + '_' + idx).value;
            localStorage.setItem(key + dateKey, JSON.stringify(data));
            showToast("å·²ä¿å­˜");
        }

        // --- 7. å¤‡ä»½é€»è¾‘ (åŒ…å«è§„åˆ’é…ç½®) ---
        function exportData() {
            let data = {};
            for(let i=0; i<localStorage.length; i++){
                let k = localStorage.key(i);
                if(k.startsWith('hunan_')) data[k] = localStorage.getItem(k);
            }
            const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `æ¹–å—çœè€ƒå®šåˆ¶è®¡åˆ’å¤‡ä»½_${formatDate(new Date())}.json`;
            a.click();
        }

        function importData(input) {
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const data = JSON.parse(e.target.result);
                    for(let k in data) localStorage.setItem(k, data[k]);
                    alert("å…¨éƒ¨æ•°æ®ï¼ˆå«è‡ªå®šä¹‰è§„åˆ’ï¼‰å¯¼å…¥æˆåŠŸï¼"); location.reload();
                } catch(e) { alert("æ–‡ä»¶è§£æå¤±è´¥"); }
            };
            reader.readAsText(input.files[0]);
        }

        // --- åŸºç¡€å¯¼èˆªä¸è¾…åŠ© ---
        function showToast(msg) { const t=document.getElementById('toast'); t.innerText=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1000); }
        function changeDay(o) { currentViewDate.setDate(currentViewDate.getDate()+o); render(); }
        function goToToday() { currentViewDate = new Date(); render(); }
        function showSettings() { document.getElementById('settingsModal').classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function openHistoryModal() {
            document.getElementById('historyModal').classList.add('active');
            const body = document.getElementById('historyContent');
            body.innerHTML = '';
            let itr = new Date(START_DATE);
            while (itr <= new Date()) {
                const d = new Date(itr); const k = formatDate(d);
                const savedDone = JSON.parse(localStorage.getItem('hunan_exam_'+k) || '[]');
                if(savedDone.length > 0) {
                    body.innerHTML += `<div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;" onclick="viewDate('${k}')">
                        <span>${d.getMonth()+1}æœˆ${d.getDate()}æ—¥</span>
                        <span style="color:var(--success)">${savedDone.length}é¡¹å®Œæˆ</span>
                    </div>`;
                }
                itr.setDate(itr.getDate()+1);
            }
        }
        function viewDate(k) { currentViewDate = new Date(k); render(); closeModal('historyModal'); }

        render();
    </script>
</body>
</html>
