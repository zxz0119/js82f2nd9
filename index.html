<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026æ¹–å—çœè€ƒå†²åˆº (è®¡æ—¶ç¬”è®°ç‰ˆ)</title>
    <style>
        :root {
            --primary: #D32F2F; --primary-dark: #b71c1c; --secondary: #1976D2;
            --bg: #f5f7fa; --card: #ffffff; --text: #333333; --subtext: #666666;
            --success: #4CAF50; --warning: #FF9800; --process: #0288D1;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg); color: var(--text);
            margin: 0; padding: 0; padding-bottom: 100px;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- å¤´éƒ¨ --- */
        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; padding: 15px 20px 25px 20px;
            border-radius: 0 0 25px 25px; box-shadow: 0 4px 15px rgba(211, 47, 47, 0.3);
            position: relative;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .app-title { font-weight: 800; font-size: 1.1rem; }
        
        .btn-group { display: flex; gap: 8px; }
        .icon-btn {
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
            color: white; padding: 5px 10px; border-radius: 15px;
            font-size: 0.8rem; cursor: pointer; backdrop-filter: blur(5px);
        }

        .date-nav {
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(0,0,0,0.15); border-radius: 12px; padding: 10px;
            margin-bottom: 12px; backdrop-filter: blur(5px);
        }
        .nav-btn { background: none; border: none; color: white; font-size: 1.5rem; padding: 0 15px; cursor: pointer; opacity: 0.8; }
        .date-main { font-size: 1.2rem; font-weight: 700; }
        .date-sub { font-size: 0.8rem; opacity: 0.9; margin-top: 2px; }

        .progress-bar-bg { height: 6px; background: rgba(0,0,0,0.2); border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: #FFD700; width: 0%; transition: width 0.4s; }

        .back-today {
            position: absolute; bottom: -12px; left: 50%; transform: translateX(-50%);
            background: #FFD700; color: #b71c1c; padding: 5px 15px;
            border-radius: 20px; font-size: 0.75rem; font-weight: bold;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2); cursor: pointer; display: none; z-index: 10;
        }

        /* --- ä»»åŠ¡é¡¹æ ·å¼ --- */
        .task-list { padding: 0 15px; }
        .task-item {
            background: white; margin: 15px 0; padding: 16px;
            border-radius: 16px; display: flex; flex-direction: column;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03); transition: all 0.3s;
            border-left: 6px solid #ddd;
        }
        .task-item.in-progress { border-left-color: var(--process); background: #f0f9ff; }
        .task-item.completed { border-left-color: var(--success); background: #f9fff9; }
        
        .task-top-row { display: flex; align-items: flex-start; }
        .status-btn {
            width: 44px; height: 44px; border: 2px solid #ddd; border-radius: 12px;
            margin-right: 12px; flex-shrink: 0; display: flex; flex-direction: column;
            align-items: center; justify-content: center; cursor: pointer;
            font-size: 0.65rem; font-weight: bold; transition: all 0.2s;
            background: white; color: #999;
        }
        .task-item.in-progress .status-btn { border-color: var(--process); color: var(--process); }
        .task-item.completed .status-btn { background: var(--success); border-color: var(--success); color: white; }

        .task-main-info { flex: 1; }
        .task-ref-time { font-size: 0.75rem; color: #999; margin-bottom: 2px; display: block; }
        .task-item.in-progress .task-ref-time { color: var(--process); }
        
        .task-input-title {
            width: 100%; border: none; background: transparent;
            font-size: 1rem; font-weight: 600; color: var(--text);
            padding: 2px 0; border-bottom: 1px dashed #eee; outline: none;
        }

        .time-badge-row { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
        .time-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; font-weight: bold; }
        .badge-start { background: #e3f2fd; color: #0277bd; }
        .badge-end { background: #e8f5e9; color: #2e7d32; }
        .badge-duration { background: #fff3e0; color: #ef6c00; border: 1px solid #ffe0b2; }

        .task-note-area {
            width: 100%; border: none; background: #f8f8f8;
            border-radius: 8px; padding: 10px; font-size: 0.85rem;
            color: #555; margin-top: 10px; resize: none; outline: none;
            box-sizing: border-box;
        }

        .phase-card {
            background: white; margin: 20px 15px 10px 15px; padding: 18px;
            border-radius: 16px; border-left: 5px solid var(--secondary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
        }
        .phase-title { font-weight: 700; color: var(--secondary); font-size: 1.05rem; }
        .phase-desc { font-size: 0.85rem; color: var(--subtext); margin-top: 5px; }

        /* æ¨¡æ€æ¡†ä¿æŒåŸæ · */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999; display: none; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal-card { background: white; width: 92%; max-width: 450px; height: 80vh; border-radius: 20px; overflow: hidden; display: flex; flex-direction: column; }
        .modal-tabs { display: flex; border-bottom: 1px solid #eee; background: #f9f9f9; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; font-weight: bold; color: #666; }
        .tab-btn.active { color: var(--primary); border-bottom: 3px solid var(--primary); background: white; }
        .modal-body { flex: 1; overflow-y: auto; padding: 15px; }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #f5f5f5; }

        .toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 12px 24px; border-radius: 25px; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-top">
            <div class="app-title">âš–ï¸ çœè€ƒè®¡æ—¶ç¬”è®° Â· å°Šäº«ç‰ˆ</div>
            <div class="btn-group">
                <button class="icon-btn" onclick="openHistoryModal()">ğŸ“… è®°å½•</button>
                <button class="icon-btn" onclick="showSettings()">âš™ï¸ å¤‡ä»½</button>
            </div>
        </div>

        <div class="date-nav">
            <button class="nav-btn" onclick="changeDay(-1)">â€¹</button>
            <div style="text-align:center">
                <div class="date-main" id="headerDate">--æœˆ--æ—¥</div>
                <div class="date-sub" id="headerSub">--</div>
            </div>
            <button class="nav-btn" onclick="changeDay(1)">â€º</button>
        </div>
        
        <div class="progress-bar-bg"><div class="progress-fill" id="progressBar"></div></div>
        <div class="back-today" id="backTodayBtn" onclick="goToToday()">å›åˆ°ä»Šå¤©</div>
    </div>

    <div id="phaseContainer"></div>
    <div class="task-list" id="taskList"></div>

    <div class="modal-overlay" id="historyModal">
        <div class="modal-card">
            <div class="modal-tabs">
                <button class="tab-btn active" id="tabFoot" onclick="switchTab('foot')">ğŸ‘£ å¤‡è€ƒè¶³è¿¹</button>
                <button class="tab-btn" id="tabCal" onclick="switchTab('cal')">ğŸ“… å¤‡è€ƒæ—¥å†</button>
                <button style="padding:15px; border:none; background:none; font-size:1.5rem;" onclick="closeModal('historyModal')">Ã—</button>
            </div>
            <div class="modal-body" id="historyContent"></div>
        </div>
    </div>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal-card" style="height: auto; padding: 20px;">
            <h3 style="margin-top:0">æ•°æ®ç®¡ç†</h3>
            <p style="font-size:0.85rem; color:#666;">åŒ…å«è®¡æ—¶æ—¶é—´ã€ä»»åŠ¡æ ‡é¢˜ã€æ‰“å¡å¤‡æ³¨çš„æ‰€æœ‰æ•°æ®ã€‚</p>
            <button onclick="exportData()" style="width:100%; padding:12px; background:var(--secondary); color:white; border:none; border-radius:8px; margin-bottom:10px;">ğŸ“¤ å¯¼å‡ºç¬”è®°å¤‡ä»½</button>
            <button onclick="document.getElementById('importFile').click()" style="width:100%; padding:12px; background:#eee; border:none; border-radius:8px;">ğŸ“¥ å¯¼å…¥æ¢å¤æ•°æ®</button>
            <input type="file" id="importFile" style="display:none" onchange="importData(this)">
            <button onclick="closeModal('settingsModal')" style="width:100%; margin-top:15px; border:none; background:none; color:#999;">å…³é—­</button>
        </div>
    </div>

    <div class="toast" id="toast">âœ… å·²æ›´æ–°</div>

    <script>
        // --- 1. åŸºç¡€é…ç½® ---
        const EXAM_DATE = new Date('2026-03-14');
        const START_DATE = new Date('2026-01-01');
        let currentViewDate = new Date();

        const formatDate = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        const timeToMins = s => { if(!s || !s.includes(':')) return 0; const [h,m]=s.split(':').map(Number); return h*60+m; };
        const minsToTime = m => { 
            let mm = Math.max(0, Math.floor(m));
            if(mm >= 1440) return "23:59";
            return `${String(Math.floor(mm/60)).padStart(2,'0')}:${String(mm%60).padStart(2,'0')}`;
        };

        // --- 2. è®¡åˆ’å‚è€ƒæ¡†æ¶ ---
        function getRawTasks(date) {
            const month = date.getMonth() + 1;
            const day = date.getDate();
            let phase = {}; let tasks = [];

            if (month === 1 && day <= 6) {
                phase = { title: "ğŸ›  Phase 0ï¼šæ•´å¤‡æœŸ", desc: "é‡ç‚¹ï¼šç¯å¢ƒæ¸…ç†ã€ç‰©èµ„é‡‡è´­ã€å¿ƒæ€å»ºè®¾ã€‚" };
                tasks = [{t:"08:30",title:"é€šè§ˆè®¡åˆ’"},{t:"10:00",title:"ç‰©èµ„é‡‡è´­"},{t:"14:00",title:"ç¯å¢ƒæ¸…ç†"},{t:"20:00",title:"æˆ’æ–­è®¾ç½®"}];
            } else if (month === 1 && day >= 7 && day <= 27) {
                phase = { title: "ğŸ— Phase 1ï¼šåŸºçŸ³æœŸ", desc: "é‡ç‚¹ï¼šæ™¨è¯»æ¹˜æƒ…ï¼Œé‡å¡‘èµ„æ–™å…¬å¼ï¼Œæ•°é‡å…³ç³»çªç ´ã€‚" };
                tasks = [{t:"07:30",title:"èµ·å±…å¯åŠ¨"},{t:"08:00",title:"æ™¨è¯»(æ¹˜æƒ…)"},{t:"08:30",title:"èµ„æ–™åˆ†æ"},{t:"10:45",title:"æ•°é‡å…³ç³»"},{t:"14:00",title:"è¨€è¯­åˆ¤æ–­"},{t:"16:00",title:"æ·±åº¦å¤ç›˜"},{t:"17:30",title:"è¿åŠ¨"},{t:"20:00",title:"å›¾å½¢æ”¿æ²»"}];
            } else if ((month === 1 && day >= 28) || (month === 2 && day <= 3)) {
                phase = { title: "ğŸ§¨ Phase 2ï¼šæ˜¥èŠ‚æœŸ", desc: "é‡ç‚¹ï¼šå¼¹æ€§å­¦ä¹ ï¼Œä¿æŒæ‰‹æ„Ÿï¼Œåˆ·å¸¸è¯†ã€‚" };
                tasks = [{t:"09:00",title:"é˜²æ‰‹ç”Ÿè®­ç»ƒ"},{t:"14:00",title:"æ¹–å—å¸¸è¯†"},{t:"16:00",title:"å±…å®¶è¿åŠ¨"}];
            } else if (month === 2 && day >= 4) {
                phase = { title: "ğŸš€ Phase 3ï¼šæé€ŸæœŸ", desc: "é‡ç‚¹ï¼šç†ç§‘/æ–‡ç§‘äº¤å‰å¼ºæ”»ï¼Œç”³è®ºæ‰‹å†™å®æˆ˜ã€‚" };
                tasks = [{t:"08:30",title:"ğŸ”´ å¼ºæ”»ä¸“é¡¹"},{t:"10:45",title:"ğŸ”µ è¾…ç»ƒä¸“é¡¹"},{t:"14:00",title:"ç”³è®ºæ‰‹å†™"},{t:"17:30",title:"è¿åŠ¨"},{t:"20:00",title:"é”™é¢˜æ¸…é›¶"}];
            } else if (month === 3 && day <= 13) {
                phase = { title: "ğŸ Phase 4ï¼šæ¨¡è€ƒæœŸ", desc: "é‡ç‚¹ï¼šå…¨çœŸæ¨¡è€ƒï¼Œé€‚åº”è€ƒåœºèŠ‚å¥ï¼ŒæŠ¼é¢˜èƒŒè¯µã€‚" };
                tasks = [{t:"09:00",title:"âš¡ å…¨çœŸæ¨¡è€ƒ"},{t:"14:00",title:"ç”³è®ºå¤ç›˜"},{t:"19:00",title:"æŠ¼é¢˜èƒŒè¯µ"}];
            } else { phase = { title: "â³ éå¤‡è€ƒæœŸ", desc: "æš‚æ— å‚è€ƒè®¡åˆ’ã€‚" }; }
            return { info: phase, tasks: tasks };
        }

        // --- 3. æ¸²æŸ“é€»è¾‘ (è®¡æ—¶é‡æ„ç‰ˆ) ---
        function render() {
            const dateKey = formatDate(currentViewDate);
            const raw = getRawTasks(currentViewDate);
            
            document.getElementById('headerDate').innerText = `${currentViewDate.getMonth()+1}æœˆ${currentViewDate.getDate()}æ—¥`;
            const diff = Math.ceil((EXAM_DATE - currentViewDate)/86400000);
            document.getElementById('headerSub').innerText = dateKey === formatDate(new Date()) ? `è·çœè€ƒ ${diff} å¤©` : `å¾€æ—¥ç¬”è®°`;
            document.getElementById('backTodayBtn').style.display = (dateKey === formatDate(new Date())) ? 'none' : 'block';

            document.getElementById('phaseContainer').innerHTML = `<div class="phase-card"><div class="phase-title">${raw.info.title}</div><div class="phase-desc">${raw.info.desc}</div></div>`;

            // åŠ è½½æ•°æ®
            const savedStarts = JSON.parse(localStorage.getItem('hunan_start_times_' + dateKey) || '{}');
            const savedEnds = JSON.parse(localStorage.getItem('hunan_actual_times_' + dateKey) || '{}');
            const savedDone = JSON.parse(localStorage.getItem('hunan_exam_' + dateKey) || '[]');
            const savedActualTasks = JSON.parse(localStorage.getItem('hunan_actual_tasks_' + dateKey) || '{}');
            const savedNotes = JSON.parse(localStorage.getItem('hunan_notes_' + dateKey) || '{}');

            const listEl = document.getElementById('taskList');
            listEl.innerHTML = '';

            let lastEndTimeMins = 0;

            raw.tasks.forEach((t, i) => {
                const startTime = savedStarts[i];
                const endTime = savedEnds[i];
                const isDone = savedDone.includes(i);
                const isInProgress = startTime && !endTime;
                
                const actualTitle = savedActualTasks[i] || t.title;
                const noteValue = savedNotes[i] || '';

                // è®¡ç®—è€—æ—¶
                let durationText = "";
                if(startTime && endTime) {
                    const diff = timeToMins(endTime) - timeToMins(startTime);
                    durationText = diff > 0 ? `${diff}åˆ†é’Ÿ` : "è·¨å¤©æˆ–è¯¯å·®";
                }

                // è®¡ç®—è¯¥ä»»åŠ¡çš„â€œåŠ¨æ€å‚è€ƒæ—¶é—´â€
                let dynamicRef = t.t;
                if(i > 0 && lastEndTimeMins > 0) {
                    // å¦‚æœå‰ä¸€ä¸ªä»»åŠ¡ç»“æŸäº†ï¼Œè®¡ç®—å‰ä¸€ä¸ªä»»åŠ¡çš„åŸå®šç»“æŸåˆ°ç°åœ¨çš„åç§»
                    // ç®€åŒ–é€»è¾‘ï¼šç›´æ¥æ˜¾ç¤ºâ€œå»ºè®®æ¥ç»­ä¸Šä¸ªä»»åŠ¡â€
                    dynamicRef = `æ¥ç»­ä¸Šé¡¹`;
                }
                if(endTime) lastEndTimeMins = timeToMins(endTime);

                let statusClass = isDone ? 'completed' : (isInProgress ? 'in-progress' : '');
                let btnLabel = isDone ? 'å®Œæˆ' : (isInProgress ? 'ç»“æŸ' : 'å¼€å§‹');

                listEl.innerHTML += `
                    <div class="task-item ${statusClass}">
                        <div class="task-top-row">
                            <div class="status-btn" onclick="handleTimerClick(${i})">
                                <span>${btnLabel}</span>
                            </div>
                            <div class="task-main-info">
                                <span class="task-ref-time">å‚è€ƒ: ${t.t} â†’ ${dynamicRef}</span>
                                <input type="text" class="task-input-title" id="title_${i}" 
                                    value="${actualTitle}" onchange="saveData(${i}, 'title')" placeholder="è‡ªå®šä¹‰ä»»åŠ¡...">
                                <div class="time-badge-row">
                                    ${startTime ? `<span class="time-badge badge-start">å§‹ ${startTime}</span>` : ''}
                                    ${endTime ? `<span class="time-badge badge-end">ç»ˆ ${endTime}</span>` : ''}
                                    ${durationText ? `<span class="time-badge badge-duration">â±ï¸ ${durationText}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <textarea class="task-note-area" id="note_${i}" rows="2" 
                            placeholder="å†™ä¸‹å¿ƒå¾—ã€é”™é¢˜é‡ç‚¹..." onchange="saveData(${i}, 'note')">${noteValue}</textarea>
                    </div>`;
            });
            document.getElementById('progressBar').style.width = (raw.tasks.length ? (savedDone.length/raw.tasks.length*100) : 0) + '%';
        }

        // --- 4. è®¡æ—¶é€»è¾‘ ---
        function handleTimerClick(idx) {
            const dateKey = formatDate(currentViewDate);
            let starts = JSON.parse(localStorage.getItem('hunan_start_times_' + dateKey) || '{}');
            let ends = JSON.parse(localStorage.getItem('hunan_actual_times_' + dateKey) || '{}');
            let done = JSON.parse(localStorage.getItem('hunan_exam_' + dateKey) || '[]');

            const now = new Date();
            const nowStr = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;

            if (!starts[idx]) {
                // ç¬¬ä¸€æ­¥ï¼šè®°å½•å¼€å§‹
                const time = prompt("è®°å½•å¼€å§‹æ—¶é—´:", nowStr);
                if (time === null) return;
                starts[idx] = time || nowStr;
            } else if (starts[idx] && !ends[idx]) {
                // ç¬¬äºŒæ­¥ï¼šè®°å½•ç»“æŸ
                const time = prompt("è®°å½•ç»“æŸæ—¶é—´:", nowStr);
                if (time === null) return;
                ends[idx] = time || nowStr;
                if(!done.includes(idx)) done.push(idx);
            } else {
                // ç¬¬ä¸‰æ­¥ï¼šé‡ç½®
                if(confirm("ç¡®å®šè¦é‡ç½®è¯¥ä»»åŠ¡çš„è®¡æ—¶å—ï¼Ÿ")) {
                    delete starts[idx];
                    delete ends[idx];
                    done = done.filter(x => x !== idx);
                } else return;
            }

            localStorage.setItem('hunan_start_times_' + dateKey, JSON.stringify(starts));
            localStorage.setItem('hunan_actual_times_' + dateKey, JSON.stringify(ends));
            localStorage.setItem('hunan_exam_' + dateKey, JSON.stringify(done));
            render();
        }

        function saveData(idx, type) {
            const dateKey = formatDate(currentViewDate);
            const key = type === 'title' ? 'hunan_actual_tasks_' : 'hunan_notes_';
            let data = JSON.parse(localStorage.getItem(key + dateKey) || '{}');
            data[idx] = document.getElementById(type + '_' + idx).value;
            localStorage.setItem(key + dateKey, JSON.stringify(data));
            showToast("ç¬”è®°å·²è‡ªåŠ¨ä¿å­˜");
        }

        // --- 5. å¤‡ä»½é€»è¾‘ (å…¨é‡å­˜å‚¨è¦†ç›–) ---
        function exportData() {
            let data = {};
            for(let i=0; i<localStorage.length; i++){
                let k = localStorage.key(i);
                if(k.includes('hunan_')) data[k] = localStorage.getItem(k);
            }
            const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `çœè€ƒè®¡æ—¶æ—¥è®°_${formatDate(new Date())}.json`;
            a.click();
        }

        function importData(input) {
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const data = JSON.parse(e.target.result);
                    for(let k in data) localStorage.setItem(k, data[k]);
                    alert("ç¬”è®°ä¸æ—¶é—´è®°å½•å¯¼å…¥æˆåŠŸï¼"); location.reload();
                } catch(e) { alert("æ–‡ä»¶è§£æå¤±è´¥"); }
            };
            reader.readAsText(input.files[0]);
        }

        // --- åŸºç¡€å¯¼èˆªä¸è¾…åŠ© ---
        function showToast(msg) { const t=document.getElementById('toast'); t.innerText=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1000); }
        function changeDay(o) { currentViewDate.setDate(currentViewDate.getDate()+o); render(); }
        function goToToday() { currentViewDate = new Date(); render(); }
        function showSettings() { document.getElementById('settingsModal').classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function openHistoryModal() { document.getElementById('historyModal').classList.add('active'); switchTab('foot'); }
        function switchTab(t) { activeTab = t; refreshHistoryList(); }
        
        function refreshHistoryList() {
            const body = document.getElementById('historyContent');
            body.innerHTML = '';
            let itr = new Date(START_DATE);
            while (itr <= new Date()) {
                const d = new Date(itr); const k = formatDate(d);
                const savedDone = JSON.parse(localStorage.getItem('hunan_exam_'+k) || '[]');
                body.innerHTML += `<div class="history-item" onclick="viewDate('${k}')">
                    <span>${d.getMonth()+1}æœˆ${d.getDate()}æ—¥</span>
                    <span style="color:var(--success); font-weight:bold">${savedDone.length}é¡¹æˆ</span>
                </div>`;
                itr.setDate(itr.getDate()+1);
            }
        }
        function viewDate(k) { currentViewDate = new Date(k); render(); closeModal('historyModal'); }

        render();
    </script>
</body>
</html>
