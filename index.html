<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <link rel="manifest" href="manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026æ¹–å—çœè€ƒå†²åˆº (ç™½é‡‘å…¨èƒ½ç‰ˆ)</title>
    <style>
        :root {
            --primary: #D32F2F; --primary-dark: #b71c1c; --secondary: #1976D2;
            --bg: #f5f7fa; --card: #ffffff; --text: #333333; --subtext: #666666;
            --success: #4CAF50; --warning: #FF9800; --cutoff: #212121;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg); color: var(--text);
            margin: 0; padding: 0; padding-bottom: 100px;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- å¤´éƒ¨ä¸æ§åˆ¶é¢æ¿ --- */
        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; padding: 15px 20px 25px 20px;
            border-radius: 0 0 25px 25px; box-shadow: 0 4px 15px rgba(211, 47, 47, 0.3);
            position: relative;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .app-title { font-weight: 800; font-size: 1.1rem; }
        
        .btn-group { display: flex; gap: 8px; }
        .icon-btn {
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
            color: white; padding: 5px 10px; border-radius: 15px;
            font-size: 0.8rem; cursor: pointer; backdrop-filter: blur(5px);
        }

        .manual-shift-panel {
            background: rgba(255,255,255,0.15); border-radius: 12px; padding: 8px 12px;
            margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between;
            font-size: 0.85rem; border: 1px solid rgba(255,255,255,0.1);
        }
        .manual-shift-panel input[type="time"] {
            background: white; border: none; border-radius: 4px; padding: 2px 5px;
            width: 70px; text-align: center; color: var(--primary); font-weight: bold;
        }

        .date-nav {
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(0,0,0,0.15); border-radius: 12px; padding: 10px;
            margin-bottom: 12px; backdrop-filter: blur(5px);
        }
        .nav-btn { background: none; border: none; color: white; font-size: 1.5rem; padding: 0 15px; cursor: pointer; opacity: 0.8; }
        .date-main { font-size: 1.2rem; font-weight: 700; }
        .date-sub { font-size: 0.8rem; opacity: 0.9; margin-top: 2px; }

        .reset-link {
            font-size: 0.7rem; color: #FFD700; text-decoration: underline; 
            margin-top: 5px; display: inline-block; cursor: pointer;
        }

        .time-shift-notice {
            background: rgba(255, 235, 59, 0.2); border: 1px solid rgba(255, 235, 59, 0.4);
            color: #fff; font-size: 0.75rem; padding: 6px 12px; border-radius: 8px;
            margin-bottom: 12px; display: none; align-items: center; justify-content: center;
        }
        .time-shift-notice.active { display: flex; animation: fadeIn 0.5s; }

        .progress-bar-bg { height: 6px; background: rgba(0,0,0,0.2); border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: #FFD700; width: 0%; transition: width 0.4s; }

        .back-today {
            position: absolute; bottom: -12px; left: 50%; transform: translateX(-50%);
            background: #FFD700; color: #b71c1c; padding: 5px 15px;
            border-radius: 20px; font-size: 0.75rem; font-weight: bold;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2); cursor: pointer; display: none; z-index: 10;
        }

        /* --- ä»»åŠ¡åˆ—è¡¨ --- */
        .task-list { padding: 0 15px; }
        .task-item {
            background: white; margin: 12px 0; padding: 16px;
            border-radius: 16px; display: flex; align-items: flex-start;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02); transition: all 0.2s;
        }
        .task-item.locked { opacity: 0.5; filter: grayscale(0.8); }
        .task-item.completed { background: #f1f8e9; border: 1px solid #c5e1a5; }
        .checkbox {
            width: 24px; height: 24px; border: 2px solid #ddd; border-radius: 7px;
            margin-right: 15px; flex-shrink: 0; display: flex; align-items: center; justify-content: center;
        }
        .task-item.completed .checkbox { background: var(--success); border-color: var(--success); }
        .task-item.completed .checkbox::after { content: 'âœ“'; color: white; font-size: 16px; font-weight: bold; }
        .task-item.completed .task-title { color: var(--success); }
        
        .task-content { flex: 1; }
        .task-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .task-title { font-weight: 600; font-size: 1rem; }
        
        .task-time { 
            font-size: 0.8rem; font-weight: 700; color: var(--primary); 
            background: #ffebee; padding: 3px 8px; border-radius: 6px; 
            min-width: 50px; text-align: center;
        }
        .task-time.actual { background: var(--success); color: white; }
        .task-time.shifted { color: #E65100; background: #FFF3E0; border: 1px solid #FFE0B2; }
        .original-time { font-size: 0.7rem; color: #999; text-decoration: line-through; margin-right: 5px; }
        .task-detail { font-size: 0.85rem; color: #666; line-height: 1.4; }

        .phase-card {
            background: white; margin: 20px 15px 15px 15px; padding: 18px;
            border-radius: 16px; border-left: 5px solid var(--secondary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
        }
        .phase-title { font-weight: 700; color: var(--secondary); font-size: 1.05rem; }
        .phase-tag { background: #e3f2fd; color: var(--secondary); font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; }
        .phase-desc { font-size: 0.9rem; color: var(--subtext); margin-top: 5px; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 999;
            display: none; align-items: center; justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal-card {
            background: white; width: 90%; max-width: 450px; height: 80vh;
            border-radius: 20px; overflow: hidden; display: flex; flex-direction: column;
        }
        .modal-tabs { display: flex; border-bottom: 1px solid #eee; background: #f9f9f9; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; font-weight: bold; cursor: pointer; color: #666; }
        .tab-btn.active { color: var(--primary); border-bottom: 3px solid var(--primary); background: white; }
        .modal-body { flex: 1; overflow-y: auto; padding: 20px; }
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #f5f5f5; cursor: pointer; }
        .h-status { width: 10px; height: 10px; border-radius: 50%; margin-right: 10px; display:inline-block; }

        .toast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8); color: white; padding: 12px 24px;
            border-radius: 25px; font-size: 0.9rem; z-index: 1000;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-top">
            <div class="app-title">â° çœè€ƒåŠ©æ‰‹ Â· å°Šäº«ç‰ˆ</div>
            <div class="btn-group">
                <button class="icon-btn" onclick="openHistoryModal()">ğŸ“… æ—¥å†</button>
                <button class="icon-btn" onclick="showSettings()">âš™ï¸ å¤‡ä»½</button>
            </div>
        </div>

        <div class="manual-shift-panel">
            <span>ğŸ›  å¯åŠ¨ç‚¹ï¼š<input type="time" id="manualStartTime" onchange="setManualShift()"></span>
            <button class="icon-btn" id="dynamicToggle" onclick="toggleDynamicMode()" style="background: rgba(255,255,255,0.3); min-width: 100px;">â±ï¸ åŠ¨æ€é¡ºå»¶: å¼€</button>
        </div>

        <div class="date-nav">
            <button class="nav-btn" onclick="changeDay(-1)">â€¹</button>
            <div style="text-align:center">
                <div class="date-main" id="headerDate">--æœˆ--æ—¥</div>
                <div class="date-sub" id="headerSub">--</div>
                <div class="reset-link" onclick="clearManualShift()">â†º é‡ç½®æ‰€æœ‰è®°å½•</div>
            </div>
            <button class="nav-btn" onclick="changeDay(1)">â€º</button>
        </div>
        
        <div class="time-shift-notice" id="shiftNotice"></div>
        <div class="progress-bar-bg"><div class="progress-fill" id="progressBar"></div></div>
        <div class="back-today" id="backTodayBtn" onclick="goToToday()">å›åˆ°ä»Šå¤©</div>
    </div>

    <div id="phaseContainer"></div>
    <div class="task-list" id="taskList"></div>

    <div class="modal-overlay" id="historyModal">
        <div class="modal-card">
            <div class="modal-tabs">
                <button class="tab-btn active" id="tabFoot" onclick="switchTab('foot')">ğŸ‘£ å¤‡è€ƒè¶³è¿¹</button>
                <button class="tab-btn" id="tabCal" onclick="switchTab('cal')">ğŸ“… å¤‡è€ƒæ—¥å†</button>
                <button style="padding:15px; border:none; background:none; font-size:1.5rem;" onclick="closeModal('historyModal')">Ã—</button>
            </div>
            <div class="modal-body" id="historyContent"></div>
        </div>
    </div>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal-card" style="height: auto; padding: 20px;">
            <h3 style="margin-top:0">æ•°æ®ç®¡ç†</h3>
            <p style="font-size:0.85rem; color:#666;">å»ºè®®æ¯å‘¨å¤‡ä»½ä¸€æ¬¡ã€‚</p>
            <button onclick="exportData()" style="width:100%; padding:12px; background:var(--secondary); color:white; border:none; border-radius:8px; margin-bottom:10px;">ğŸ“¤ å¯¼å‡ºæœ¬åœ°å¤‡ä»½</button>
            <button onclick="document.getElementById('importFile').click()" style="width:100%; padding:12px; background:#eee; border:none; border-radius:8px;">ğŸ“¥ å¯¼å…¥æ¢å¤æ•°æ®</button>
            <input type="file" id="importFile" style="display:none" onchange="importData(this)">
            <button onclick="closeModal('settingsModal')" style="width:100%; margin-top:15px; border:none; background:none; color:#999;">å…³é—­</button>
        </div>
    </div>

    <div class="toast" id="toast">âœ… å·²æ‰“å¡</div>

    <script>
        // --- 1. åŸºç¡€é…ç½® ---
        const EXAM_DATE = new Date('2026-03-14');
        const START_DATE = new Date('2026-01-01');
        let currentViewDate = new Date();

        const formatDate = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        const timeToMins = s => { if(!s || !s.includes(':')) return -1; const [h,m]=s.split(':').map(Number); return h*60+m; };
        
        const minsToTime = m => { 
            if (m >= 1440) return "23:59"; 
            let totalMins = Math.max(0, Math.floor(m)); 
            let h=Math.floor(totalMins/60), mm=totalMins%60; 
            return `${String(h).padStart(2,'0')}:${String(mm).padStart(2,'0')}`; 
        };

        function getExerciseType(date) {
            const base = new Date('2026-01-01');
            const diff = Math.floor((date - base) / 86400000);
            return (diff % 2 === 0) ? "ğŸ’¤ ä¼‘æ¯æ—¥ (æ•£æ­¥/æ‹‰ä¼¸)" : "ğŸ”¥ åŠ›é‡+æœ‰æ°§ (1å°æ—¶)";
        }

        // --- 2. è®¡åˆ’å†…å®¹ ---
        function getRawTasks(date) {
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const dayOfWeek = date.getDay();
            let phase = {};
            let tasks = [];

            if (month === 1 && day <= 6) {
                phase = { title: "ğŸ›  Phase 0ï¼šç‰©èµ„ä¸èº«å¿ƒæ•´å¤‡", desc: "å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨ã€‚", tag: "å‡†å¤‡" };
                tasks = [
                    { t: "08:30", title: "ğŸ“… è®¡åˆ’é€šè§ˆ", detail: "é˜…è¯»å†²åˆºè®¡åˆ’ï¼Œç†è§£é‡å¿ƒã€‚", type: "info" },
                    { t: "10:00", title: "ğŸ–Šï¸ ç‰©èµ„é‡‡è´­", detail: "0.5mmé»‘ç¬”, 2Bæ¶‚å¡ç¬”, é”™é¢˜æœ¬ã€‚", type: "todo" },
                    { t: "14:00", title: "ğŸ§¹ ç¯å¢ƒæ¸…ç†", detail: "æ¸…ç†ä¹¦æ¡Œï¼Œç§»é™¤æ‚ç‰©ã€‚", type: "todo" },
                    { t: "16:00", title: "ğŸ’Š è¡¥å‰‚å‡†å¤‡", detail: "å¤åˆç»´Bï¼Œç»´Cï¼ŒæŠ—ç–²åŠ³è¡¥å‰‚ã€‚", type: "todo" },
                    { t: "20:00", title: "ğŸ“± æˆ’æ–­è®¾ç½®", detail: "æŠ–éŸ³/æ¸¸æˆé™åˆ¶æ¯æ—¥15åˆ†é’Ÿã€‚", type: "todo" },
                    { t: "22:30", title: "ğŸ’¤ å¼ºåˆ¶æ—©ç¡", detail: "è°ƒæ•´ç”Ÿç‰©é’Ÿï¼Œç¦æ­¢ç†¬å¤œã€‚", type: "health" }
                ];
            } else if (month === 1 && day >= 7 && day <= 27) {
                phase = { title: "ğŸ— Phase 1ï¼šåŸºçŸ³ä¿®å¤æœŸ", desc: "æ‰¾å›è‚Œè‚‰è®°å¿†ï¼Œå»ºç«‹å¸¸è¯†æ¡†æ¶ã€‚", tag: "æ‰“åŸºç¡€" };
                tasks = [
                    { t: "07:30", title: "èµ·å±… & å¯åŠ¨", detail: "æ¸©æ°´400ml + ç»´B/C", type: "health" },
                    { t: "08:00", title: "æ™¨è¯» (æ¹˜æƒ…)", detail: "ä¸‰é«˜å››æ–°/2025æŠ¥å‘Š/æˆè¯­200ä¸ª", type: "study" },
                    { t: "08:30", title: "èµ„æ–™åˆ†æ (é‡å¡‘)", detail: "é»˜å†™å…¬å¼ -> æ…¢åš20é¢˜", type: "study" },
                    { t: "10:30", title: "ä¼‘æ¯", detail: "è¿œçœº5åˆ†é’Ÿï¼Œå–æ°´", type: "health" },
                    { t: "10:45", title: "æ•°é‡å…³ç³»", detail: "å·¥ç¨‹/è¡Œç¨‹/ç»æµã€‚5-10é“çœŸé¢˜", type: "study" },
                    { t: "12:00", title: "åˆé¤ & è¡¥å‰‚", detail: "ä¸ƒåˆ†é¥±ã€‚åˆä¼‘30åˆ†", type: "health" },
                    { t: "14:00", title: "è¨€è¯­/åˆ¤æ–­", detail: "é€»è¾‘å¡«ç©º20é¢˜ + ç‰‡æ®µ10é¢˜", type: "study" },
                    { t: "16:00", title: "æ·±åº¦å¤ç›˜", detail: "é‡åšé”™é¢˜ï¼Œå½’çº³åŸå› ", type: "study" },
                    { t: "17:30", title: "è¿åŠ¨æ—¶é—´", detail: getExerciseType(date), type: "health" },
                    { t: "20:00", title: "å›¾å½¢ & æ”¿æ²»", detail: "å›¾æ¨20é¢˜ + æ”¿æ²»ç½‘è¯¾", type: "study" },
                    { t: "23:00", title: "æ™šå®‰", detail: "å›é¡¾å…¬å¼ï¼Œç¡è§‰", type: "health" }
                ];
            } else if ((month === 1 && day >= 28) || (month === 2 && day <= 3)) {
                phase = { title: "ğŸ§¨ Phase 2ï¼šæ˜¥èŠ‚ä¿æ‰‹æ„Ÿ", desc: "å¼¹æ€§å­¦ä¹ ï¼Œä¸æ–­æ¡£ã€‚", tag: "ç»´æŒ" };
                tasks = [
                    { t: "09:00", title: "é˜²æ‰‹ç”Ÿè®­ç»ƒ", detail: "èµ„æ–™åˆ†æ15é¢˜ + å›¾æ¨10é¢˜", type: "study" },
                    { t: "14:00", title: "æ¹–å—å¸¸è¯†", detail: "åˆ·'æ–°æ¹–å—'App", type: "study" },
                    { t: "å…¨å¤©", title: "å±…å®¶è¿åŠ¨", detail: "æ·±è¹²/ä¿¯å§æ’‘ 30åˆ†é’Ÿ", type: "health" }
                ];
            } else if (month === 2 && day >= 4) {
                const isModeA = [0, 1, 3, 5].includes(dayOfWeek);
                phase = { title: "ğŸš€ Phase 3ï¼šæé€ŸæœŸ", desc: isModeA ? "ç†ç§‘ä¸»æ”»" : "æ–‡ç§‘ä¸»æ”»", tag: "æé€Ÿ" };
                tasks = [
                    { t: "07:30", title: "èµ·å±…", detail: "æ°´ + ç»´B/C", type: "health" },
                    { t: "08:30", title: isModeA ? "ğŸ”´ å¼ºæ”»:èµ„æ–™" : "ğŸ”´ å¼ºæ”»:è¨€è¯­åˆ¤æ–­", detail: isModeA ? "é™æ—¶40é¢˜ï¼Œæ§æ—¶30åˆ†" : "é™æ—¶75é¢˜æ¨¡æ‹Ÿ", type: "study" },
                    { t: "10:45", title: isModeA ? "ğŸ”µ è¾…ç»ƒ:æ•°é‡" : "ğŸ”µ è¾…ç»ƒ:èµ„æ–™", detail: "ä¿æŒæ‰‹æ„Ÿè®­ç»ƒ", type: "study" },
                    { t: "14:00", title: "ç”³è®ºä¸“é¡¹", detail: isModeA ? "æ‹†è§£èŒƒæ–‡ç»“æ„" : "æ‰‹å†™å°é¢˜å®æˆ˜", type: "study" },
                    { t: "17:30", title: "è¿åŠ¨", detail: getExerciseType(date), type: "health" },
                    { t: "20:00", title: "é”™é¢˜æ¸…é›¶", detail: "æ•´ç†ä»Šæ—¥é”™é¢˜", type: "study" }
                ];
            } else if (month === 3 && day <= 13) {
                phase = { title: "ğŸ Phase 4ï¼šå…¨çœŸæ¨¡è€ƒ", desc: "é€‚åº”è€ƒåœºæ—¶é—´ã€‚", tag: "å†²åˆº" };
                tasks = [
                    { t: "07:00", title: "æ—©èµ·æ¨¡æ‹Ÿ", detail: "æ¨¡æ‹Ÿè€ƒè¯•æ—¥èµ·åºŠæ—¶é—´", type: "health" },
                    { t: "09:00", title: "âš¡ å…¨çœŸæ¨¡è€ƒ", detail: "120åˆ†é’Ÿè¡Œæµ‹ï¼Œå¿…é¡»æ¶‚å¡", type: "study" },
                    { t: "14:00", title: "ç”³è®º/å¤ç›˜", detail: "éš”å¤©æ¨¡è€ƒç”³è®º", type: "study" },
                    { t: "19:00", title: "æŠ¼é¢˜èƒŒè¯µ", detail: "æ—¶æ”¿/è€ƒå‰30åˆ†", type: "study" },
                    { t: "22:30", title: "å¼ºåˆ¶æ—©ç¡", detail: "è°ƒæ•´ç”Ÿç‰©é’Ÿ", type: "health" }
                ];
            } else { phase = { title: "â³ éå¤‡è€ƒæœŸ", desc: "ä¸åœ¨è®¡åˆ’èŒƒå›´å†…", tag: "ç­‰å¾…" }; }
            return { info: phase, tasks: tasks };
        }

        // --- 3. è®¡ç®—æ ¸å¿ƒ ---
        function processTasksWithDynamicShift(rawTasks, isToday) {
            const dateKey = formatDate(currentViewDate);
            const savedIndices = JSON.parse(localStorage.getItem('hunan_exam_' + dateKey) || '[]');
            const actualTimes = JSON.parse(localStorage.getItem('hunan_actual_times_' + dateKey) || '{}');
            const manualStart = localStorage.getItem('manual_start_' + dateKey);
            const isDynamicMode = localStorage.getItem('hunan_dynamic_mode') !== 'false';

            let currentShift = 0;
            const firstTimed = rawTasks.find(t => t.t.includes(':'));
            
            if (firstTimed) {
                const planStart = timeToMins(firstTimed.t);
                if (manualStart) {
                    currentShift = timeToMins(manualStart) - planStart;
                } else if (isToday && savedIndices.length === 0) {
                    const nowMins = new Date().getHours() * 60 + new Date().getMinutes();
                    if (nowMins > planStart + 30) {
                        currentShift = Math.floor((nowMins - planStart) / 15) * 15;
                    }
                }
            }

            const processed = rawTasks.map((t, i) => {
                const origMins = timeToMins(t.t);
                if (origMins === -1) return { ...t };
                let displayTime, status = '', originalTime = null;

                if (savedIndices.includes(i) && actualTimes[i]) {
                    displayTime = actualTimes[i];
                    if (isDynamicMode) currentShift = timeToMins(actualTimes[i]) - origMins;
                    status = 'actual';
                    originalTime = t.t;
                } else {
                    const shiftedMins = origMins + currentShift;
                    displayTime = minsToTime(shiftedMins); 
                    status = currentShift !== 0 ? 'shifted' : '';
                    if(currentShift !== 0) originalTime = t.t;
                }
                return { ...t, displayTime, originalTime, status };
            });

            return { tasks: processed, shift: currentShift, mode: isDynamicMode };
        }

        // --- 4. æ¸²æŸ“æ ¸å¿ƒ ---
        function render() {
            const isToday = formatDate(currentViewDate) === formatDate(new Date());
            const raw = getRawTasks(currentViewDate);
            const processed = processTasksWithDynamicShift(raw.tasks, isToday);
            
            document.getElementById('headerDate').innerText = `${currentViewDate.getMonth()+1}æœˆ${currentViewDate.getDate()}æ—¥`;
            const diff = Math.ceil((EXAM_DATE - currentViewDate)/86400000);
            document.getElementById('headerSub').innerText = isToday ? `è·çœè€ƒ ${diff} å¤©` : (currentViewDate > new Date() ? `æœªæ¥è®¡åˆ’` : `å›é¡¾`);
            document.getElementById('backTodayBtn').style.display = isToday ? 'none' : 'block';

            const toggleBtn = document.getElementById('dynamicToggle');
            toggleBtn.innerText = `â±ï¸ åŠ¨æ€é¡ºå»¶: ${processed.mode ? 'å¼€' : 'å…³'}`;
            toggleBtn.style.opacity = processed.mode ? '1' : '0.6';

            const noticeEl = document.getElementById('shiftNotice');
            if (processed.shift !== 0) {
                noticeEl.innerText = processed.mode ? `ğŸ”„ åç»­éšèŠ‚å¥é¡ºå»¶ ${Math.abs(processed.shift)} åˆ†é’Ÿ` : `ğŸ“ å¯åŠ¨ç‚¹å›ºå®šé¡ºå»¶ ${Math.abs(processed.shift)} åˆ†é’Ÿ`;
                noticeEl.classList.add('active');
            } else { noticeEl.classList.remove('active'); }

            document.getElementById('phaseContainer').innerHTML = `
                <div class="phase-card">
                    <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                        <div class="phase-title">${raw.info.title}</div>
                        <div class="phase-tag">${raw.info.tag}</div>
                    </div>
                    <div class="phase-desc">${raw.info.desc}</div>
                </div>`;

            const k = 'hunan_exam_' + formatDate(currentViewDate);
            const saved = JSON.parse(localStorage.getItem(k) || '[]');
            const listEl = document.getElementById('taskList');
            listEl.innerHTML = '';
            
            processed.tasks.forEach((t, i) => {
                const checked = saved.includes(i);
                const isLocked = i > 0 && !saved.includes(i-1) && !checked;
                listEl.innerHTML += `
                    <div class="task-item ${checked?'completed':''} ${isLocked?'locked':''}" onclick="toggleTask(${i})">
                        <div class="checkbox"></div>
                        <div class="task-content">
                            <div class="task-header">
                                <span class="task-title">${t.title}</span>
                                <span class="task-time ${t.status}">
                                    ${t.originalTime ? `<span class="original-time">${t.originalTime}</span>` : ''}
                                    ${t.displayTime}
                                </span>
                            </div>
                            <div class="task-detail">${t.detail}</div>
                        </div>
                    </div>`;
            });
            document.getElementById('progressBar').style.width = (raw.tasks.length ? (saved.length/raw.tasks.length*100) : 0) + '%';
        }

        // --- 5. ä¸šåŠ¡é€»è¾‘ ---
        function toggleDynamicMode() {
            const current = localStorage.getItem('hunan_dynamic_mode') !== 'false';
            localStorage.setItem('hunan_dynamic_mode', !current);
            render();
            showToast(`åŠ¨æ€é¡ºå»¶å·²${!current ? 'å¼€å¯' : 'å…³é—­'}`);
        }

        function toggleTask(i) {
            const dateKey = formatDate(currentViewDate);
            const k = 'hunan_exam_' + dateKey;
            const tk = 'hunan_actual_times_' + dateKey;
            let saved = JSON.parse(localStorage.getItem(k) || '[]');
            let actualTimes = JSON.parse(localStorage.getItem(tk) || '{}');
            
            if (saved.includes(i)) {
                if (saved.some(index => index > i)) {
                    showToast("âš ï¸ è¯·å…ˆå–æ¶ˆåç»­ä»»åŠ¡", "warning"); return;
                }
                saved = saved.filter(x => x !== i);
                delete actualTimes[i];
            } else {
                if (i > 0 && !saved.includes(i - 1)) {
                    showToast("ğŸ”’ è¯·æŒ‰é¡ºåºæ‰“å¡", "warning"); return;
                }

                // --- ä¿®æ”¹ç‚¹ï¼šå¼¹å‡ºæ—¶é—´é€‰æ‹©æ¡† ---
                let defaultTime = "";
                const now = new Date();
                const currentTime = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
                
                const manualStart = localStorage.getItem('manual_start_' + dateKey);
                // ç¬¬ä¸€ä¸ªè®¡åˆ’é»˜è®¤ä½¿ç”¨æ‰‹åŠ¨å¯åŠ¨ç‚¹ï¼Œå…¶ä»–ä»»åŠ¡é»˜è®¤å½“å‰ç°å®æ—¶é—´
                if (i === 0 && manualStart) {
                    defaultTime = manualStart;
                } else {
                    defaultTime = currentTime;
                }

                const userTime = prompt("è¯·è¾“å…¥æ­¤ä»»åŠ¡çš„æ‰“å¡æ—¶é—´ (æ ¼å¼ HH:mm):", defaultTime);
                
                // ç”¨æˆ·ç‚¹å‡»å–æ¶ˆåˆ™ä¸æ‰“å¡
                if (userTime === null) return;

                // ç®€å•çš„æ­£åˆ™éªŒè¯ HH:mm
                if (/^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/.test(userTime)) {
                    actualTimes[i] = userTime;
                } else {
                    alert("æ—¶é—´æ ¼å¼é”™è¯¯ (æ­£ç¡®ç¤ºä¾‹ 08:30)ï¼Œå·²è‡ªåŠ¨ä½¿ç”¨é»˜è®¤æ—¶é—´");
                    actualTimes[i] = defaultTime;
                }

                saved.push(i);
            }
            localStorage.setItem(k, JSON.stringify(saved));
            localStorage.setItem(tk, JSON.stringify(actualTimes));
            render();
        }

        function setManualShift() {
            const time = document.getElementById('manualStartTime').value;
            if(time) { localStorage.setItem('manual_start_' + formatDate(currentViewDate), time); render(); }
        }

        function clearManualShift() {
            if(!confirm("ç¡®å®šé‡ç½®å—ï¼Ÿ")) return;
            const dk = formatDate(currentViewDate);
            localStorage.removeItem('manual_start_' + dk);
            localStorage.removeItem('hunan_exam_' + dk);
            localStorage.removeItem('hunan_actual_times_' + dk);
            render();
        }

        function showToast(msg, type) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.background = type === 'warning' ? '#E65100' : 'rgba(0,0,0,0.8)';
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 1500);
        }

        function exportData() {
            let data = {};
            for(let i=0; i<localStorage.length; i++){
                let k = localStorage.key(i);
                if(k.startsWith('hunan_') || k.startsWith('manual_start_')) {
                    data[k] = localStorage.getItem(k);
                }
            }
            const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `çœè€ƒå¤‡ä»½_${formatDate(new Date())}.json`;
            a.click();
        }

        function importData(input) {
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const data = JSON.parse(e.target.result);
                    for(let k in data) localStorage.setItem(k, data[k]);
                    alert("å¯¼å…¥æˆåŠŸï¼Œè®°å½•å·²å®Œå…¨æ¢å¤"); location.reload();
                } catch(e) { alert("æ ¼å¼é”™è¯¯"); }
            };
            reader.readAsText(input.files[0]);
        }

        function openHistoryModal() { document.getElementById('historyModal').classList.add('active'); refreshHistoryList(); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function changeDay(o) { currentViewDate.setDate(currentViewDate.getDate()+o); render(); }
        function goToToday() { currentViewDate = new Date(); render(); }
        function showSettings() { document.getElementById('settingsModal').classList.add('active'); }
        function switchTab(t) { activeTab = t; refreshHistoryList(); }

        function refreshHistoryList() {
            const body = document.getElementById('historyContent');
            body.innerHTML = '';
            let itr = new Date(START_DATE);
            while (itr <= new Date()) {
                const d = new Date(itr); const k = formatDate(d);
                const saved = JSON.parse(localStorage.getItem('hunan_exam_'+k) || '[]');
                body.innerHTML += `<div class="history-item" onclick="viewDate('${k}')">
                    <span>${d.getMonth()+1}æœˆ${d.getDate()}æ—¥</span>
                    <span>${saved.length}ä¸ªä»»åŠ¡</span>
                </div>`;
                itr.setDate(itr.getDate()+1);
            }
        }
        function viewDate(k) { currentViewDate = new Date(k); render(); closeModal('historyModal'); }

        render();
        setInterval(() => { if(formatDate(currentViewDate) === formatDate(new Date())) render(); }, 60000);
    </script>
</body>
</html>

