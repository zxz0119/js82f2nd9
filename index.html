<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026æ¹–å—çœè€ƒè®¡æ—¶ç¬”è®°</title>
    <style>
        :root {
            --primary: #D32F2F; --primary-dark: #b71c1c; --secondary: #1976D2;
            --bg: #f5f7fa; --card: #ffffff; --text: #333333; --success: #4CAF50; 
            --process: #0288D1; --warning: #FF9800; --border: #eeeeee;
        }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 160px; -webkit-tap-highlight-color: transparent; }
        
        /* --- å¤´éƒ¨åŒºåŸŸ --- */
        .header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 15px 20px 25px 20px; border-radius: 0 0 25px 25px; position: relative; box-shadow: 0 4px 15px rgba(211,47,47,0.2); z-index: 10; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .app-title { font-weight: 800; font-size: 1.1rem; letter-spacing: 0.5px; }
        .icon-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; transition: 0.2s; }
        .date-nav { display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.15); border-radius: 12px; padding: 10px; margin-bottom: 12px; }
        .nav-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0 10px; line-height: 1; }
        .progress-bar-bg { height: 6px; background: rgba(0,0,0,0.2); border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: #FFD700; width: 0%; transition: width 0.4s; }
        .back-today { position: absolute; bottom: -12px; left: 50%; transform: translateX(-50%); background: #FFD700; color: #b71c1c; padding: 5px 15px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; cursor: pointer; display: none; border: 1px solid #b71c1c; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* --- ä»»åŠ¡é¡¹æ ·å¼ --- */
        .phase-card { background: white; margin: 20px 15px 10px 15px; padding: 15px; border-radius: 16px; border-left: 5px solid var(--secondary); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .task-list { padding: 0 15px; }
        .task-item { background: white; margin: 15px 0; padding: 16px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); border-left: 6px solid #ddd; position: relative; transition: 0.3s; }
        .task-item.in-progress { border-left-color: var(--process); background: #f0f9ff; }
        .task-item.completed { border-left-color: var(--success); background: #f9fff9; }
        
        .del-day-btn { position: absolute; top: 12px; right: 12px; color: #ff5252; font-size: 0.9rem; cursor: pointer; border: 1px solid #ffebee; background: #fff; padding: 2px 6px; border-radius: 6px; font-weight: bold; }
        .status-btn { width: 64px; height: 64px; border: 2px solid #ddd; border-radius: 16px; margin-right: 14px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.75rem; font-weight: bold; background: white; color: #999; text-align: center; }
        .task-item.completed .status-btn { background: var(--success); border-color: var(--success); color: white; }
        .task-item.in-progress .status-btn { border-color: var(--process); color: var(--process); }

        .task-input-title { width: 85%; border: none; background: transparent; font-size: 1rem; font-weight: 600; padding: 2px 0; border-bottom: 1px dashed #eee; outline: none; margin-bottom: 4px; color: var(--text); }
        .time-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; font-weight: bold; background: #f0f0f0; color: #666; margin-right: 6px; }
        .duration-badge { font-size: 0.7rem; color: white; background: var(--warning); padding: 2px 8px; border-radius: 4px; font-weight: bold; }
        .task-note-area { width: 100%; border: none; background: #f8f8f8; border-radius: 10px; padding: 12px; font-size: 0.85rem; margin-top: 10px; resize: none; outline: none; box-sizing: border-box; color: #555; }

        /* --- åº•éƒ¨è¡¨å•æ¨¡æ€æ¡† --- */
        .bottom-modal { position: fixed; bottom: 0; left: 0; right: 0; background: white; z-index: 2000; border-radius: 25px 25px 0 0; padding: 20px 20px 40px 20px; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 -5px 25px rgba(0,0,0,0.15); }
        .bottom-modal.active { transform: translateY(0); }
        .modal-mask { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1999; display: none; backdrop-filter: blur(2px); }
        
        .form-row { margin-bottom: 15px; }
        .form-label { display: block; font-size: 0.85rem; color: #666; margin-bottom: 6px; font-weight: bold; }
        .form-input { width: 100%; padding: 14px; border: 2px solid #eee; border-radius: 12px; font-size: 1rem; box-sizing: border-box; outline: none; }
        .form-input:focus { border-color: var(--secondary); }
        .btn-confirm { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 14px; font-weight: bold; font-size: 1rem; cursor: pointer; box-shadow: 0 4px 10px rgba(211,47,47,0.3); }

        /* --- åº•éƒ¨DIYæ“ä½œæ  --- */
        .daily-action-bar { padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        .btn-add-daily { width: 100%; padding: 14px; background: #fff; color: var(--secondary); border: 1px dashed var(--secondary); border-radius: 14px; font-weight: bold; cursor: pointer; font-size: 0.9rem; }
        .btn-clear-daily { color: #999; border: none; background: none; font-size: 0.8rem; text-decoration: underline; margin-bottom: 10px; cursor: pointer; }

        /* --- å¤§æ¨¡æ€æ¡†åŸºç¡€ (æ—¥å†/è§„åˆ’) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999; display: none; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal-card { background: white; width: 94%; max-width: 500px; height: 85vh; border-radius: 24px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-header { padding: 18px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-weight: bold; background: #fafafa; }
        .modal-tabs { display: flex; background: #f0f0f0; padding: 5px; gap: 5px; }
        .tab-btn { flex: 1; padding: 12px; border: none; border-radius: 12px; cursor: pointer; font-size: 0.85rem; background: none; color: #666; transition: 0.3s; }
        .tab-btn.active { background: white; color: var(--primary); font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .modal-body { flex: 1; overflow-y: auto; padding: 15px; }
        
        .edit-phase-section { border: 1px solid #eee; border-radius: 15px; padding: 15px; margin-bottom: 20px; background: #fafafa; }
        .toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); color: white; padding: 12px 24px; border-radius: 25px; z-index: 3000; opacity: 0; pointer-events: none; transition: 0.3s; font-weight: bold; }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-top">
            <div class="app-title">2026 æ¹–å—çœè€ƒå†²åˆºè®°å½•</div>
            <div class="btn-group">
                <button class="icon-btn" onclick="openPlanModal()">è§„åˆ’</button>
                <button class="icon-btn" onclick="openHistoryModal()">æ—¥å†</button>
                <button class="icon-btn" onclick="showSettings()">å¤‡ä»½</button>
            </div>
        </div>
        <div class="date-nav">
            <button class="nav-btn" onclick="changeDay(-1)">â€¹</button>
            <div style="text-align:center">
                <div id="headerDate" style="font-size: 1.2rem; font-weight: 700;">1æœˆ1æ—¥</div>
                <div id="headerSub" style="font-size: 0.8rem; opacity: 0.9;">è·çœè€ƒ 0 å¤©</div>
            </div>
            <button class="nav-btn" onclick="changeDay(1)">â€º</button>
        </div>
        <div class="progress-bar-bg"><div class="progress-fill" id="progressBar"></div></div>
        <div class="back-today" id="backTodayBtn" onclick="goToToday()">å›åˆ°ä»Šå¤©</div>
    </div>

    <div id="phaseContainer"></div>
    <div class="task-list" id="taskList"></div>
    
    <div class="daily-action-bar">
        <button class="btn-add-daily" onclick="openAddTaskModal()">+ ä¸ºä»Šæ—¥å¢åŠ ç‰¹æ®Šä»»åŠ¡ (æ»‘åŠ¨é€‰æ—¶)</button>
        <button class="btn-clear-daily" onclick="clearDailyTasks()">ğŸ—‘ï¸ ä¸€é”®æ¸…ç©ºä»Šæ—¥åˆ—è¡¨ (ä¸å½±å“æ¨¡æ¿)</button>
    </div>

    <div class="modal-mask" id="globalMask" onclick="closeAllBottomModals()"></div>
    <div class="bottom-modal" id="timePickerModal">
        <div id="timeModalTitle" style="font-weight:bold; text-align:center; color:var(--secondary); margin-bottom:15px;">ç¡®è®¤æ‰“å¡æ—¶é—´</div>
        <div class="form-row">
            <input type="time" id="nativeTimeInput" class="form-input" style="height:70px; font-size:2rem; text-align:center;">
        </div>
        <button class="btn-confirm" onclick="confirmTimeSelection()">ç¡®è®¤å¹¶ä¿å­˜æ‰“å¡</button>
    </div>

    <div class="bottom-modal" id="addTaskFormModal">
        <div style="font-weight:bold; text-align:center; color:var(--secondary); margin-bottom:15px;">æ–°å¢ä»Šæ—¥ä»»åŠ¡</div>
        <div class="form-row">
            <label class="form-label">ä»»åŠ¡åç§°</label>
            <input type="text" id="new_title" class="form-input" placeholder="è¾“å…¥ä»»åŠ¡åç§°...">
        </div>
        <div class="form-row">
            <label class="form-label">è®¡åˆ’å‚è€ƒæ—¶é—´</label>
            <input type="time" id="new_time" class="form-input" value="09:00">
        </div>
        <div class="form-row" style="display:flex; align-items:center; gap:10px; background:#f9f9f9; padding:12px; border-radius:12px;">
            <input type="checkbox" id="new_isDur" style="width:22px; height:22px;">
            <label for="new_isDur" style="font-size:0.95rem; font-weight:bold;">å¼€å¯è®¡æ—¶æ¨¡å¼ (è®°å½•å¼€å§‹+ç»“æŸ)</label>
        </div>
        <button class="btn-confirm" onclick="submitNewTaskDaily()">åŠ å…¥ä»Šæ—¥æ¸…å•</button>
        <button onclick="closeAllBottomModals()" style="width:100%; border:none; background:none; color:#999; margin-top:15px; font-size:0.9rem;">å–æ¶ˆ</button>
    </div>

    <div class="modal-overlay" id="planModal"><div class="modal-card">
        <div class="modal-header"><span>é˜¶æ®µè§„åˆ’æ¨¡æ¿(ä¿®æ”¹åå…¨å±€ç”Ÿæ•ˆ)</span><button onclick="closeModal('planModal')" style="border:none;background:none;font-size:1.5rem">âœ•</button></div>
        <div class="modal-body" id="planEditorBody"></div>
        <button onclick="saveAllPlans()" class="btn-confirm" style="border-radius:0;">ğŸ’¾ ä¿å­˜å…¨å±€æ¨¡æ¿</button>
    </div></div>

    <div class="modal-overlay" id="historyModal"><div class="modal-card">
        <div class="modal-header"><span>æ—¥å†åˆ‡æ¢</span><button onclick="closeModal('historyModal')" style="border:none;background:none;font-size:1.5rem">âœ•</button></div>
        <div class="modal-tabs">
            <button class="tab-btn active" id="tabPast" onclick="switchCalendar('past')">å¤‡è€ƒè¶³è¿¹ (è¿‡å»)</button>
            <button class="tab-btn" id="tabFuture" onclick="switchCalendar('future')">é¢„è§æœªæ¥ (å°†æ¥)</button>
        </div>
        <div class="modal-body" id="historyContent"></div>
    </div></div>

    <div class="modal-overlay" id="settingsModal"><div class="modal-card" style="height: auto; padding: 25px;">
        <h3 style="margin:0 0 15px 0;">å…¨é‡æ•°æ®å¤‡ä»½</h3>
        <p style="font-size:0.8rem; color:#666; margin-bottom:20px;">å¤‡ä»½åŒ…å«ï¼šå…¨å±€æ¨¡æ¿ã€å•æ—¥DIYä»»åŠ¡ã€æ‰€æœ‰æ‰“å¡æ—¶é—´ã€æ‰€æœ‰ç¬”è®°å¤ç›˜ã€‚</p>
        <button onclick="exportData()" class="btn-confirm" style="background:var(--secondary); margin-bottom:12px;">ğŸ“¤ å¯¼å‡ºå¤‡ä»½æ–‡ä»¶ (.json)</button>
        <button onclick="document.getElementById('importFile').click()" class="btn-confirm" style="background:#eee; color:#333; box-shadow:none;">ğŸ“¥ å¯¼å…¥æ¢å¤æ•°æ®</button>
        <input type="file" id="importFile" style="display:none" onchange="importData(this)">
        <button onclick="resetAllData()" style="color:red; border:none; background:none; width:100%; margin-top:25px; font-size:0.9rem; font-weight:bold;">ğŸ—‘ï¸ é‡ç½®æ‰€æœ‰æœ¬åœ°æ•°æ®</button>
    </div></div>

    <div class="toast" id="toast">åŒæ­¥æˆåŠŸ</div>

    <script>
        const EXAM_DATE = new Date('2026-03-14');
        const START_DATE = new Date('2026-01-01');
        let currentViewDate = new Date();
        let calType = 'past';
        let activeTaskContext = { idx: -1, planned: '', isDur: false };

        // --- æ ¸å¿ƒä¸šåŠ¡ï¼šPhase 0 - 4 å®Œæ•´é¢„è®¾æ•°æ®é€»è¾‘ ---
        const DEFAULT_PLAN_CONFIG = [
            { id: 0, title: "Phase 0ï¼šç‰©èµ„ä¸èº«å¿ƒæ•´å¤‡", desc: "å·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨ã€‚æ¸…ç†ä¹¦æ¡Œï¼Œå‡†å¤‡0.5mmé»‘ç¬”ã€2Bé“…ç¬”ã€ç»´Bè¡¥å‰‚ã€‚", range: [1,1,1,6], tasks: [
                {t:"08:30", title:"ğŸ“… è®¡åˆ’é€šè§ˆ (é˜…è¯»é‡å¿ƒ)", isDuration:false},
                {t:"10:00", title:"ğŸ–Šï¸ ç‰©èµ„é‡‡è´­ (é»‘ç¬”/é”™é¢˜æœ¬)", isDuration:false},
                {t:"14:00", title:"ğŸ§¹ ç¯å¢ƒæ¸…ç† (æ¸…ç©ºä¹¦æ¡Œ)", isDuration:false},
                {t:"16:00", title:"ğŸ’Š è¡¥å‰‚å‡†å¤‡ (ç»´B/ç»´C)", isDuration:false},
                {t:"20:00", title:"ğŸ“± æˆ’æ–­è®¾ç½® (é™æ—¶App)", isDuration:false},
                {t:"22:30", title:"ğŸ’¤ å¼ºåˆ¶æ—©ç¡ (è°ƒç”Ÿç‰©é’Ÿ)", isDuration:false}
            ]},
            { id: 1, title: "Phase 1ï¼šåŸºçŸ³ä¿®å¤æœŸ", desc: "æ‰¾å›è‚Œè‚‰è®°å¿†ã€‚ä¾§é‡èµ„æ–™åˆ†æå…¬å¼ã€æ•°é‡å…³ç³»çœŸé¢˜ã€å¸¸è¯†æ¡†æ¶ã€‚", range: [1,7,1,27], tasks: [
                {t:"07:30", title:"èµ·å±…å¯åŠ¨ (400mlæ¸©æ°´)", isDuration:false},
                {t:"08:00", title:"æ™¨è¯»æ¹˜æƒ… (ä¸‰é«˜å››æ–°)", isDuration:false},
                {t:"08:30", title:"èµ„æ–™åˆ†æ (é»˜å†™å…¬å¼)", isDuration:true},
                {t:"10:30", title:"ä¼‘æ¯è¿œçœº (è¿œçœº5åˆ†é’Ÿ)", isDuration:false},
                {t:"10:45", title:"æ•°é‡å…³ç³» (è¡Œç¨‹/ç»æµçœŸé¢˜)", isDuration:true},
                {t:"12:00", title:"åˆé¤åˆä¼‘ (ä¸ƒåˆ†é¥±)", isDuration:false},
                {t:"14:00", title:"è¨€è¯­åˆ¤æ–­ (é€»è¾‘å¡«ç©º)", isDuration:true},
                {t:"16:00", title:"æ·±åº¦å¤ç›˜ (é‡åšé”™é¢˜)", isDuration:true},
                {t:"17:30", title:"è¿åŠ¨æ—¶é—´ (åŠ›é‡+æœ‰æ°§)", isDuration:false},
                {t:"20:00", title:"å›¾å½¢æ”¿æ²» (å›¾æ¨+ç½‘è¯¾)", isDuration:false},
                {t:"23:00", title:"æ™šå®‰ä¼‘æ¯ (ä¸ç†¬å¤œ)", isDuration:false}
            ]},
            { id: 2, title: "Phase 2ï¼šæ˜¥èŠ‚ä¿æ‰‹æ„Ÿ", desc: "å¼¹æ€§å­¦ä¹ ã€‚æ¯å¤©ä¿æŒèµ„æ–™å’Œå›¾æ¨çš„æ‰‹æ„Ÿå³å¯ã€‚", range: [1,28,2,3], tasks: [
                {t:"09:00", title:"é˜²æ‰‹ç”Ÿè®­ç»ƒ (èµ„æ–™+å›¾æ¨)", isDuration:true},
                {t:"14:00", title:"æ¹–å—å¸¸è¯† (æ–°æ¹–å—App)", isDuration:false},
                {t:"16:00", title:"å±…å®¶è¿åŠ¨ (æ·±è¹²/ä¿¯å§æ’‘)", isDuration:false}
            ]},
            { id: 3, title: "Phase 3ï¼šæé€Ÿæ”»åšæœŸ", desc: "æ–‡ç†äº¤å‰å¼ºæ”»ã€‚é™æ—¶æ¨¡æ‹Ÿï¼Œç”³è®ºæ‰‹å†™å®æˆ˜ã€‚", range: [2,4,3,7], tasks: [
                {t:"07:30", title:"èµ·å±… (ç»´B/C)", isDuration:false},
                {t:"08:30", title:"ğŸ”´ å¼ºæ”»ä¸“é¡¹ (é™æ—¶40é¢˜)", isDuration:true},
                {t:"10:45", title:"ğŸ”µ è¾…ç»ƒä¸“é¡¹ (èµ„æ–™åˆ†æ)", isDuration:true},
                {t:"14:00", title:"ç”³è®ºæ‰‹å†™ (æ‹†è§£èŒƒæ–‡)", isDuration:true},
                {t:"17:30", title:"è¿åŠ¨ (æ•£æ­¥/æ‹‰ä¼¸)", isDuration:false},
                {t:"20:00", title:"ä»Šæ—¥é”™é¢˜ (æ¸…é›¶å¤ç›˜)", isDuration:true}
            ]},
            { id: 4, title: "Phase 4ï¼šè€ƒå‰å…¨çœŸæ¨¡è€ƒ", desc: "é€‚åº”è€ƒåœºç”Ÿç‰©é’Ÿã€‚å…¨å¥—çœŸé¢˜ï¼Œå¿…é¡»æ¶‚å¡ã€‚", range: [3,8,3,13], tasks: [
                {t:"07:00", title:"æ—©èµ·æ¨¡æ‹Ÿ (è€ƒåœºæ—¶é—´)", isDuration:false},
                {t:"09:00", title:"âš¡ å…¨çœŸæ¨¡è€ƒ (120åˆ†é’Ÿ)", isDuration:true},
                {t:"14:00", title:"ç”³è®ºå¤ç›˜ (éš”å¤©æ¨¡è€ƒ)", isDuration:true},
                {t:"19:00", title:"æŠ¼é¢˜èƒŒè¯µ (è€ƒå‰30åˆ†)", isDuration:false},
                {t:"22:30", title:"å¼ºåˆ¶æ—©ç¡ (æ”¾æ¾å¿ƒæ€)", isDuration:false}
            ]}
        ];

        const getPlans = () => JSON.parse(localStorage.getItem('hunan_plan_config') || JSON.stringify(DEFAULT_PLAN_CONFIG));
        const formatDate = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        const timeToMins = s => { if(!s || !s.includes(':')) return 0; const [h,m]=s.split(':').map(Number); return h*60+m; };

        // --- é€»è¾‘ï¼šè¯»å–å½“å¤©ä»»åŠ¡ (ä¼˜å…ˆ DIY) ---
        function getDailyTaskList(date) {
            const dk = formatDate(date);
            const dailyCustom = localStorage.getItem('hunan_daily_tasks_' + dk);
            if (dailyCustom) return JSON.parse(dailyCustom);
            const m = date.getMonth()+1; const d = date.getDate(); const plans = getPlans();
            let f = plans.find(p => { const [sm,sd,em,ed]=p.range; return (m*100+d) >= (sm*100+sd) && (m*100+d) <= (em*100+ed); });
            return f ? JSON.parse(JSON.stringify(f.tasks)) : [];
        }

        function render() {
            const dk = formatDate(currentViewDate); 
            const tasks = getDailyTaskList(currentViewDate);
            const m = currentViewDate.getMonth()+1; const d = currentViewDate.getDate(); 
            const plans = getPlans();
            let phaseInfo = plans.find(p => { const [sm,sd,em,ed]=p.range; return (m*100+d) >= (sm*100+sd) && (m*100+d) <= (em*100+ed); }) || {title:"è‡ªç”±ç»ƒä¹ æœŸ", desc:"è‡ªä¸»å®‰æ’"};

            document.getElementById('headerDate').innerText = `${m}æœˆ${d}æ—¥`;
            const diff = Math.ceil((EXAM_DATE - currentViewDate)/86400000);
            document.getElementById('headerSub').innerText = diff >= 0 ? `è· 3.14 çœè€ƒ ${diff} å¤©` : "çœè€ƒå·²é¡ºåˆ©ç»“æŸ";
            document.getElementById('backTodayBtn').style.display = (dk === formatDate(new Date())) ? 'none' : 'block';
            document.getElementById('phaseContainer').innerHTML = `<div class="phase-card"><div class="phase-title">${phaseInfo.title}</div><div class="phase-desc">${phaseInfo.desc}</div></div>`;

            const s = JSON.parse(localStorage.getItem('hunan_start_times_'+dk)||'{}');
            const e = JSON.parse(localStorage.getItem('hunan_actual_times_'+dk)||'{}');
            const done = JSON.parse(localStorage.getItem('hunan_exam_'+dk)||'[]');
            const notes = JSON.parse(localStorage.getItem('hunan_notes_'+dk)||'{}');

            const listEl = document.getElementById('taskList'); listEl.innerHTML = '';
            tasks.forEach((t, i) => {
                const isD = done.includes(i); const isDur = t.isDuration; const isP = isDur && s[i] && !e[i];
                let btnLbl = isDur ? (isD ? "å®Œæˆ" : (isP ? "è®°ç»“æŸ" : "è®°å¼€å§‹")) : (isD ? "å·²è®°" : "æ ‡è®°");
                let durTxt = (isDur && s[i] && e[i]) ? `${timeToMins(e[i]) - timeToMins(s[i])}åˆ†é’Ÿ` : "";

                listEl.innerHTML += `
                    <div class="task-item ${isD?'completed':(isP?'in-progress':'')}">
                        <button class="del-day-btn" onclick="removeTaskDaily(${i})">âœ•</button>
                        <div style="display:flex">
                            <div class="status-btn" onclick="triggerTimePicker(${i},'${t.t}',${isDur})">${btnLbl}</div>
                            <div style="flex:1">
                                <span style="font-size:0.7rem;color:#999">å‚è€ƒæ—¶é—´: ${t.t}</span>
                                <input type="text" class="task-input-title" value="${t.title}" onchange="editTaskDaily(${i}, this.value)">
                                <div style="display:flex; flex-wrap:wrap; gap:6px; margin-top:6px;">
                                    ${s[i]?`<span class="time-badge">å§‹ ${s[i]}</span>`:''}
                                    ${e[i]?`<span class="time-badge">ç»ˆ ${e[i]}</span>`:''}
                                    ${durTxt?`<span class="duration-badge">${durTxt}</span>`:''}
                                </div>
                            </div>
                        </div>
                        <textarea class="task-note-area" rows="1" placeholder="ä»Šæ—¥å¤ç›˜ç¬”è®°/é”™é¢˜è®°å½•..." onchange="saveNoteDaily(${i}, this.value)">${notes[i]||''}</textarea>
                    </div>`;
            });
            document.getElementById('progressBar').style.width = (tasks.length ? (done.length/tasks.length*100) : 0) + '%';
        }

        // --- æ ¸å¿ƒï¼šæ»‘åŠ¨æ‰“å¡é€»è¾‘ ---
        function triggerTimePicker(idx, planned, isDur) {
            const dk = formatDate(currentViewDate);
            let s = JSON.parse(localStorage.getItem('hunan_start_times_'+dk)||'{}');
            let e = JSON.parse(localStorage.getItem('hunan_actual_times_'+dk)||'{}');
            activeTaskContext = { idx, planned, isDur };
            
            // æ¨¡å¼åˆ¤æ–­ï¼šé‡ç½®æˆ–æ‰“å¡
            if (!isDur && s[idx]) { if(confirm("é‡ç½®æ ‡è®°ï¼Ÿ")){ delete s[idx]; clearEntry(idx,dk); } return; }
            if (isDur && s[idx] && e[idx]) { if(confirm("é‡ç½®è®¡æ—¶è®°å½•ï¼Ÿ")){ delete s[idx]; delete e[idx]; clearEntry(idx,dk); } return; }

            const now = new Date();
            const realTime = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            document.getElementById('nativeTimeInput').value = realTime;
            document.getElementById('timeModalTitle').innerText = isDur ? (s[idx]?"è®°ç»“æŸæ—¶é—´":"è®°å¼€å§‹æ—¶é—´") : "æ ‡è®°æ‰“å¡æ—¶é—´";
            
            document.getElementById('timePickerModal').classList.add('active');
            document.getElementById('globalMask').style.display = 'block';
        }

        function confirmTimeSelection() {
            const dk = formatDate(currentViewDate);
            const val = document.getElementById('nativeTimeInput').value;
            const { idx, isDur } = activeTaskContext;
            let s = JSON.parse(localStorage.getItem('hunan_start_times_'+dk)||'{}');
            let e = JSON.parse(localStorage.getItem('hunan_actual_times_'+dk)||'{}');
            let d = JSON.parse(localStorage.getItem('hunan_exam_'+dk)||'[]');

            if (!isDur) { s[idx] = val; if(!d.includes(idx)) d.push(idx); }
            else { if(!s[idx]) s[idx] = val; else { e[idx] = val; if(!d.includes(idx)) d.push(idx); } }

            localStorage.setItem('hunan_start_times_'+dk, JSON.stringify(s));
            localStorage.setItem('hunan_actual_times_'+dk, JSON.stringify(e));
            localStorage.setItem('hunan_exam_'+dk, JSON.stringify(d));
            closeAllBottomModals(); render();
        }

        // --- æ ¸å¿ƒï¼šè¡¨å•å¢åŠ å•æ—¥ä»»åŠ¡ ---
        function openAddTaskModal() {
            const now = new Date();
            document.getElementById('new_time').value = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
            document.getElementById('addTaskFormModal').classList.add('active');
            document.getElementById('globalMask').style.display = 'block';
        }

        function submitNewTaskDaily() {
            const title = document.getElementById('new_title').value || "æ–°åŠ ä»»åŠ¡";
            const time = document.getElementById('new_time').value;
            const isDur = document.getElementById('new_isDur').checked;
            const dk = formatDate(currentViewDate);
            const tasks = getDailyTaskList(currentViewDate);
            tasks.push({t: time, title: title, isDuration: isDur});
            localStorage.setItem('hunan_daily_tasks_' + dk, JSON.stringify(tasks));
            document.getElementById('new_title').value = "";
            closeAllBottomModals(); render();
        }

        // --- é€šç”¨é€»è¾‘ ---
        function clearDailyTasks() { if(confirm("âš ï¸ æ¸…ç©ºä»Šæ—¥æ‰€æœ‰åˆ—è¡¨ï¼Ÿ(ä¸ä¼šä¿®æ”¹å…¨å±€æ¨¡æ¿)")){ const dk = formatDate(currentViewDate); localStorage.setItem('hunan_daily_tasks_' + dk, JSON.stringify([])); render(); } }
        function removeTaskDaily(idx) { const dk = formatDate(currentViewDate); const tasks = getDailyTaskList(currentViewDate); tasks.splice(idx, 1); localStorage.setItem('hunan_daily_tasks_' + dk, JSON.stringify(tasks)); render(); }
        function editTaskDaily(idx, val) { const dk = formatDate(currentViewDate); const tasks = getDailyTaskList(currentViewDate); tasks[idx].title = val; localStorage.setItem('hunan_daily_tasks_' + dk, JSON.stringify(tasks)); }
        function saveNoteDaily(idx, val) { const dk = formatDate(currentViewDate); let n = JSON.parse(localStorage.getItem('hunan_notes_'+dk)||'{}'); n[idx] = val; localStorage.setItem('hunan_notes_'+dk, JSON.stringify(n)); }
        function closeAllBottomModals() { document.querySelectorAll('.bottom-modal').forEach(m => m.classList.remove('active')); document.getElementById('globalMask').style.display = 'none'; }
        function clearEntry(i,dk) { let d=JSON.parse(localStorage.getItem('hunan_exam_'+dk)||'[]'); d=d.filter(x=>x!==i); localStorage.setItem('hunan_exam_'+dk,JSON.stringify(d)); render(); }

        // --- å…¶ä»–æ¨¡æ€æ¡†é€»è¾‘ ---
        let editingPlans = [];
        function openPlanModal() { editingPlans = getPlans(); renderPlanEditor(); document.getElementById('planModal').classList.add('active'); }
        function renderPlanEditor() {
            document.getElementById('planEditorBody').innerHTML = editingPlans.map((p, pIdx) => `
                <div class="edit-phase-section">
                    <div style="font-weight:bold; color:var(--primary-dark); margin-bottom:5px;">${p.title}</div>
                    <div style="font-size:0.75rem; color:#888; margin-bottom:10px;">æ—¥æœŸ: ${p.range[0]}/${p.range[1]} - ${p.range[2]}/${p.range[3]}</div>
                    ${p.tasks.map((t, tIdx) => `
                        <div style="display:flex; gap:5px; margin-bottom:8px;">
                            <input type="text" value="${t.t}" class="form-input" style="width:50px; padding:6px; font-size:0.8rem;" onchange="editingPlans[${pIdx}].tasks[${tIdx}].t=this.value">
                            <input type="text" value="${t.title}" class="form-input" style="flex:1; padding:6px; font-size:0.8rem;" onchange="editingPlans[${pIdx}].tasks[${tIdx}].title=this.value">
                            <label style="font-size:0.7rem; display:flex; align-items:center;"><input type="checkbox" ${t.isDuration?'checked':''} onchange="editingPlans[${pIdx}].tasks[${tIdx}].isDuration=this.checked">è®°æ—¶é•¿</label>
                            <button onclick="editingPlans[${pIdx}].tasks.splice(${tIdx},1);renderPlanEditor()" style="border:none;background:none;color:red;">âœ•</button>
                        </div>`).join('')}
                    <button onclick="editingPlans[${pIdx}].tasks.push({t:'09:00',title:'æ–°ä»»åŠ¡',isDuration:false});renderPlanEditor()" style="font-size:0.7rem; padding:5px; width:100%; border:1px solid #ccc; background:white; border-radius:8px;">+ æ·»åŠ åˆ°æ­¤é˜¶æ®µæ¨¡æ¿</button>
                </div>`).join('');
        }
        function saveAllPlans() { localStorage.setItem('hunan_plan_config', JSON.stringify(editingPlans)); showToast("å…¨å±€è§„åˆ’å·²æ›´æ–°"); closeModal('planModal'); render(); }
        function openHistoryModal() { document.getElementById('historyModal').classList.add('active'); renderCalendarBody(); }
        function renderCalendarBody() {
            const b = document.getElementById('historyContent'); b.innerHTML = '';
            let itr = new Date(START_DATE); const today = new Date(); today.setHours(0,0,0,0);
            while (itr <= EXAM_DATE) {
                const dk = formatDate(itr); const isPast = itr <= today;
                if ((calType === 'past' && isPast) || (calType === 'future' && !isPast)) {
                    const doneNum = JSON.parse(localStorage.getItem('hunan_exam_'+dk)||'[]').length;
                    b.innerHTML += `<div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; ${dk===formatDate(new Date())?'background:#fff9e6; border-left:4px solid #FFD700;':''}" onclick="viewDate('${dk}')">
                        <span style="font-weight:bold;">${itr.getMonth()+1}æœˆ${itr.getDate()}æ—¥</span>
                        <span style="font-size:0.8rem; color:${doneNum>0?'var(--success)':'#ccc'}">${doneNum}é¡¹å·²æˆ</span>
                    </div>`;
                }
                itr.setDate(itr.getDate()+1);
            }
        }
        function switchCalendar(t) { calType=t; document.getElementById('tabPast').className=t==='past'?'tab-btn active':'tab-btn'; document.getElementById('tabFuture').className=t==='future'?'tab-btn active':'tab-btn'; renderCalendarBody(); }
        
        // --- ç³»ç»Ÿè¾…åŠ© ---
        function changeDay(o) { currentViewDate.setDate(currentViewDate.getDate()+o); render(); }
        function goToToday() { currentViewDate = new Date(); render(); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function viewDate(k) { currentViewDate = new Date(k); render(); closeModal('historyModal'); }
        function showSettings() { document.getElementById('settingsModal').classList.add('active'); }
        function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1000); }
        function exportData() {
            let d={}; for(let i=0; i<localStorage.length; i++){ let k=localStorage.key(i); if(k.startsWith('hunan_')) d[k]=localStorage.getItem(k); }
            const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(d)],{type:'application/json'})); a.download=`æ¹–å—çœè€ƒå…¨é‡è®°å½•å¤‡ä»½_${formatDate(new Date())}.json`; a.click();
        }
        function importData(i) { const r=new FileReader(); r.onload=e=>{ try{ const d=JSON.parse(e.target.result); for(let k in d)localStorage.setItem(k,d[k]); location.reload(); }catch(e){alert("å¯¼å…¥å¤±è´¥")} }; r.readAsText(i.files[0]); }
        function resetAllData() { if(confirm("ğŸš¨ è­¦å‘Šï¼šè¿™å°†æ¸…ç©ºæ‰€æœ‰æ‰“å¡è®°å½•å’Œç¬”è®°ï¼ç¡®å®šå—ï¼Ÿ")) { localStorage.clear(); location.reload(); } }

        render();
    </script>
</body>
</html>
