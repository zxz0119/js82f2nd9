<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026æ¹–å—çœè€ƒè®¡æ—¶ç¬”è®°Â·ç»ˆæDIYç‰ˆ</title>
    <style>
        :root {
            --primary: #D32F2F; --primary-dark: #b71c1c; --secondary: #1976D2;
            --bg: #f5f7fa; --card: #ffffff; --text: #333333; --success: #4CAF50; --process: #0288D1; --warning: #FF9800;
        }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 100px; -webkit-tap-highlight-color: transparent; }
        .header { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 15px 20px 25px 20px; border-radius: 0 0 25px 25px; position: relative; box-shadow: 0 4px 15px rgba(211,47,47,0.2); }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .app-title { font-weight: 800; font-size: 1.1rem; }
        .icon-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; border: none; }
        .date-nav { display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.15); border-radius: 12px; padding: 10px; margin-bottom: 12px; }
        .nav-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; line-height: 1; }
        .progress-bar-bg { height: 6px; background: rgba(0,0,0,0.2); border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: #FFD700; width: 0%; transition: width 0.4s; }
        .back-today { position: absolute; bottom: -12px; left: 50%; transform: translateX(-50%); background: #FFD700; color: #b71c1c; padding: 5px 15px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; cursor: pointer; display: none; z-index: 10; border: 1px solid #b71c1c; }

        .phase-card { background: white; margin: 20px 15px 10px 15px; padding: 15px; border-radius: 16px; border-left: 5px solid var(--secondary); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .task-list { padding: 0 15px; }
        .task-item { background: white; margin: 15px 0; padding: 16px; border-radius: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); border-left: 6px solid #ddd; position: relative; }
        .task-item.in-progress { border-left-color: var(--process); background: #f0f9ff; }
        .task-item.completed { border-left-color: var(--success); background: #f9fff9; }
        
        /* å•æ—¥åˆ é™¤æŒ‰é’® */
        .del-day-btn { position: absolute; top: 10px; right: 10px; color: #ccc; font-size: 1.2rem; cursor: pointer; border: none; background: none; padding: 5px; }
        
        .status-btn { width: 62px; height: 62px; border: 2px solid #ddd; border-radius: 14px; margin-right: 12px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.75rem; font-weight: bold; background: white; color: #999; text-align: center; }
        .task-item.completed .status-btn { background: var(--success); border-color: var(--success); color: white; }
        .task-item.in-progress .status-btn { border-color: var(--process); color: var(--process); }

        .task-input-title { width: 85%; border: none; background: transparent; font-size: 1rem; font-weight: 600; padding: 2px 0; border-bottom: 1px dashed #eee; outline: none; color: var(--text); }
        .time-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; font-weight: bold; background: #eee; color: #666; margin-right: 5px; }
        .duration-badge { font-size: 0.7rem; color: white; background: var(--warning); padding: 2px 8px; border-radius: 4px; font-weight: bold; }
        .task-note-area { width: 100%; border: none; background: #f8f8f8; border-radius: 8px; padding: 10px; font-size: 0.85rem; margin-top: 10px; resize: none; outline: none; box-sizing: border-box; }

        .add-daily-task-box { padding: 0 15px 20px 15px; }
        .btn-add-daily { width: 100%; padding: 12px; background: #fff; color: var(--secondary); border: 1px dashed var(--secondary); border-radius: 12px; font-weight: bold; cursor: pointer; }

        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999; display: none; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal-card { background: white; width: 94%; max-width: 500px; height: 85vh; border-radius: 24px; overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { padding: 18px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .modal-tabs { display: flex; background: #f0f0f0; padding: 5px; gap: 5px; }
        .tab-btn { flex: 1; padding: 12px; border: none; border-radius: 12px; cursor: pointer; font-size: 0.85rem; background: none; color: #666; }
        .tab-btn.active { background: white; color: var(--primary); font-weight: bold; }
        .modal-body { flex: 1; overflow-y: auto; padding: 15px; }
        .edit-phase-section { border: 1px solid #eee; border-radius: 12px; padding: 12px; margin-bottom: 15px; background: #fafafa; }
        .btn-main-save { width: 100%; background: var(--primary); color: white; border: none; padding: 16px; font-weight: bold; cursor: pointer; font-size: 1rem; }
        .toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); color: white; padding: 10px 20px; border-radius: 20px; z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-top">
            <div class="app-title">2026 æ¹–å—çœè€ƒè®¡æ—¶ç¬”è®°</div>
            <div class="btn-group">
                <button class="icon-btn" onclick="openPlanModal()">è§„åˆ’</button>
                <button class="icon-btn" onclick="openHistoryModal()">æ—¥å†</button>
                <button class="icon-btn" onclick="showSettings()">å¤‡ä»½</button>
            </div>
        </div>
        <div class="date-nav">
            <button class="nav-btn" onclick="changeDay(-1)">â€¹</button>
            <div style="text-align:center">
                <div class="date-main" id="headerDate">--æœˆ--æ—¥</div>
                <div class="date-sub" id="headerSub">--</div>
            </div>
            <button class="nav-btn" onclick="changeDay(1)">â€º</button>
        </div>
        <div class="progress-bar-bg"><div class="progress-fill" id="progressBar"></div></div>
        <div class="back-today" id="backTodayBtn" onclick="goToToday()">å›åˆ°ä»Šå¤©</div>
    </div>

    <div id="phaseContainer"></div>
    <div class="task-list" id="taskList"></div>
    <div class="add-daily-task-box">
        <button class="btn-add-daily" onclick="addTaskDaily()">+ ä¸ºä»Šæ—¥å¢åŠ ç‰¹æ®Šä»»åŠ¡ (ä»…ä»Šå¤©æœ‰æ•ˆ)</button>
    </div>

    <div class="modal-overlay" id="planModal"><div class="modal-card">
        <div class="modal-header"><span>é˜¶æ®µä»»åŠ¡æ¨¡æ¿(ä¿®æ”¹å½±å“å…¨é˜¶æ®µ)</span><button onclick="closeModal('planModal')" style="border:none;background:none;font-size:1.5rem">âœ•</button></div>
        <div class="modal-body" id="planEditorBody"></div>
        <button class="btn-main-save" onclick="saveAllPlans()">ğŸ’¾ ä¿å­˜æ¨¡æ¿è§„åˆ’</button>
    </div></div>

    <div class="modal-overlay" id="historyModal"><div class="modal-card">
        <div class="modal-header"><span>å…¨æ—¶æ®µæ—¥å†</span><button onclick="closeModal('historyModal')" style="border:none;background:none;font-size:1.5rem">âœ•</button></div>
        <div class="modal-tabs"><button class="tab-btn active" id="tabPast" onclick="switchCalendar('past')">å¤‡è€ƒè¶³è¿¹</button><button class="tab-btn" id="tabFuture" onclick="switchCalendar('future')">é¢„è§æœªæ¥</button></div>
        <div class="modal-body" id="historyContent"></div>
    </div></div>

    <div class="modal-overlay" id="settingsModal"><div class="modal-card" style="height: auto; padding: 20px;">
        <h3 style="margin-top:0">å…¨é‡æ•°æ®ç®¡ç†</h3>
        <button onclick="exportData()" style="width:100%; padding:14px; background:var(--secondary); color:white; border:none; border-radius:10px; margin-bottom:10px;">ğŸ“¤ å¯¼å‡ºåŒ…å« DIY çš„å…¨é‡å¤‡ä»½</button>
        <button onclick="document.getElementById('importFile').click()" style="width:100%; padding:14px; background:#eee; border:none; border-radius:10px;">ğŸ“¥ å¯¼å…¥æ¢å¤</button>
        <input type="file" id="importFile" style="display:none" onchange="importData(this)">
        <button onclick="resetAllData()" style="width:100%; margin-top:20px; color:red; border:1px solid red; background:none; padding:10px; border-radius:10px;">ğŸ—‘ï¸ é‡ç½®æ‰€æœ‰æ•°æ®</button>
        <button onclick="closeModal('settingsModal')" style="width:100%; margin-top:15px; border:none; background:none; color:#999;">å–æ¶ˆ</button>
    </div></div>

    <div class="toast" id="toast">å·²åŒæ­¥</div>

    <script>
        const EXAM_DATE = new Date('2026-03-14');
        const START_DATE = new Date('2026-01-01');
        let currentViewDate = new Date();
        let calType = 'past';

        // --- æ ¸å¿ƒé»˜è®¤é…ç½® ---
        const DEFAULT_PLAN_CONFIG = [
            { id: 0, title: "Phase 0ï¼šç‰©èµ„ä¸èº«å¿ƒæ•´å¤‡", desc: "å·¥æ¬²å–„å…¶äº‹ã€‚æ¸…ç†ä¹¦æ¡Œï¼Œå‡†å¤‡é»‘ç¬”ã€2Bé“…ç¬”ã€ç»´Bè¡¥å‰‚ã€‚", range: [1,1,1,6], tasks: [{t:"08:30", title:"ğŸ“… è®¡åˆ’é€šè§ˆ (é˜…è¯»é‡å¿ƒ)", isDuration:false},{t:"10:00", title:"ğŸ–Šï¸ ç‰©èµ„é‡‡è´­ (é»‘ç¬”/é”™é¢˜æœ¬)", isDuration:false},{t:"14:00", title:"ğŸ§¹ ç¯å¢ƒæ¸…ç† (æ¸…ç©ºä¹¦æ¡Œ)", isDuration:false},{t:"16:00", title:"ğŸ’Š è¡¥å‰‚å‡†å¤‡ (ç»´B/ç»´C)", isDuration:false},{t:"20:00", title:"ğŸ“± æˆ’æ–­è®¾ç½® (é™æ—¶App)", isDuration:false},{t:"22:30", title:"ğŸ’¤ å¼ºåˆ¶æ—©ç¡ (è°ƒç”Ÿç‰©é’Ÿ)", isDuration:false}]},
            { id: 1, title: "Phase 1ï¼šåŸºçŸ³ä¿®å¤æœŸ", desc: "æ‰¾å›è‚Œè‚‰è®°å¿†ã€‚ä¾§é‡èµ„æ–™å…¬å¼ã€æ•°é‡çœŸé¢˜ã€å¸¸è¯†æ¡†æ¶ã€‚", range: [1,7,1,27], tasks: [{t:"07:30", title:"èµ·å±…å¯åŠ¨ (400mlæ¸©æ°´)", isDuration:false},{t:"08:00", title:"æ™¨è¯»æ¹˜æƒ… (ä¸‰é«˜å››æ–°)", isDuration:false},{t:"08:30", title:"èµ„æ–™åˆ†æ (é»˜å†™å…¬å¼)", isDuration:true},{t:"10:30", title:"ä¼‘æ¯è¿œçœº (5åˆ†é’Ÿ)", isDuration:false},{t:"10:45", title:"æ•°é‡å…³ç³» (è¡Œç¨‹çœŸé¢˜)", isDuration:true},{t:"14:00", title:"è¨€è¯­åˆ¤æ–­ (é€»è¾‘å¡«ç©º)", isDuration:true},{t:"16:00", title:"æ·±åº¦å¤ç›˜ (é‡åšé”™é¢˜)", isDuration:true},{t:"17:30", title:"è¿åŠ¨æ—¶é—´ (åŠ›é‡+æœ‰æ°§)", isDuration:false},{t:"20:00", title:"å›¾å½¢æ”¿æ²» (å›¾æ¨+ç½‘è¯¾)", isDuration:false}]},
            { id: 2, title: "Phase 2ï¼šæ˜¥èŠ‚ä¿æ‰‹æ„Ÿ", desc: "å¼¹æ€§å­¦ä¹ ã€‚æ¯å¤©ä¿æŒèµ„æ–™å’Œå›¾æ¨çš„æ‰‹æ„Ÿã€‚", range: [1,28,2,3], tasks: [{t:"09:00", title:"é˜²æ‰‹ç”Ÿè®­ç»ƒ (èµ„æ–™+å›¾æ¨)", isDuration:true},{t:"14:00", title:"æ¹–å—å¸¸è¯† (æ–°æ¹–å—App)", isDuration:false},{t:"16:00", title:"å±…å®¶è¿åŠ¨ (æ·±è¹²/ä¿¯å§æ’‘)", isDuration:false}]},
            { id: 3, title: "Phase 3ï¼šæé€Ÿæ”»åšæœŸ", desc: "æ–‡ç†äº¤å‰å¼ºæ”»ã€‚é™æ—¶æ¨¡æ‹Ÿï¼Œç”³è®ºæ‰‹å†™ã€‚", range: [2,4,3,7], tasks: [{t:"07:30", title:"èµ·å±… (ç»´B/C)", isDuration:false},{t:"08:30", title:"ğŸ”´ å¼ºæ”»ä¸“é¡¹ (é™æ—¶40é¢˜)", isDuration:true},{t:"10:45", title:"ğŸ”µ è¾…ç»ƒä¸“é¡¹ (èµ„æ–™åˆ†æ)", isDuration:true},{t:"14:00", title:"ç”³è®ºæ‰‹å†™ (æ‹†è§£èŒƒæ–‡)", isDuration:true},{t:"17:30", title:"è¿åŠ¨ (æ•£æ­¥/æ‹‰ä¼¸)", isDuration:false},{t:"20:00", title:"ä»Šæ—¥é”™é¢˜ (æ¸…é›¶å¤ç›˜)", isDuration:true}]},
            { id: 4, title: "Phase 4ï¼šè€ƒå‰å…¨çœŸæ¨¡è€ƒ", desc: "é€‚åº”è€ƒåœºç”Ÿç‰©é’Ÿã€‚å…¨å¥—çœŸé¢˜ï¼Œå¿…é¡»æ¶‚å¡ã€‚", range: [3,8,3,13], tasks: [{t:"07:00", title:"æ—©èµ·æ¨¡æ‹Ÿ (è€ƒåœºæ—¶é—´)", isDuration:false},{t:"09:00", title:"âš¡ å…¨çœŸæ¨¡è€ƒ (120åˆ†é’Ÿ)", isDuration:true},{t:"14:00", title:"ç”³è®ºå¤ç›˜ (éš”å¤©æ¨¡è€ƒ)", isDuration:true},{t:"19:00", title:"æŠ¼é¢˜èƒŒè¯µ (è€ƒå‰30åˆ†)", isDuration:false},{t:"22:30", title:"å¼ºåˆ¶æ—©ç¡ (æ”¾æ¾å¿ƒæ€)", isDuration:false}]}
        ];

        const getPlans = () => JSON.parse(localStorage.getItem('hunan_plan_config') || JSON.stringify(DEFAULT_PLAN_CONFIG));
        const formatDate = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        const timeToMins = s => { if(!s || !s.includes(':')) return 0; const [h,m]=s.split(':').map(Number); return h*60+m; };

        // --- æ ¸å¿ƒé€»è¾‘ï¼šè·å–å½“å¤©çš„ä»»åŠ¡åˆ—è¡¨ï¼ˆæ”¯æŒå•æ—¥ DIY è¦†ç›–ï¼‰ ---
        function getDailyTaskList(date) {
            const dk = formatDate(date);
            const dailyCustom = localStorage.getItem('hunan_daily_tasks_' + dk);
            if (dailyCustom) return JSON.parse(dailyCustom);
            
            // å¦‚æœæ²¡ DIY è¿‡ï¼Œåˆ™åŠ è½½æ¨¡æ¿
            const m = date.getMonth()+1; const d = date.getDate(); const plans = getPlans();
            let f = plans.find(p => { const [sm,sd,em,ed]=p.range; return (m*100+d) >= (sm*100+sd) && (m*100+d) <= (em*100+ed); });
            return f ? JSON.parse(JSON.stringify(f.tasks)) : [];
        }

        function render() {
            const dk = formatDate(currentViewDate); 
            const tasks = getDailyTaskList(currentViewDate);
            const m = currentViewDate.getMonth()+1; const d = currentViewDate.getDate(); 
            const plans = getPlans();
            let phaseInfo = plans.find(p => { const [sm,sd,em,ed]=p.range; return (m*100+d) >= (sm*100+sd) && (m*100+d) <= (em*100+ed); }) || {title:"è‡ªç”±å†²åˆºæœŸ", desc:"è‡ªç”±å®‰æ’"};

            document.getElementById('headerDate').innerText = `${m}æœˆ${d}æ—¥`;
            const diff = Math.ceil((EXAM_DATE - currentViewDate)/86400000);
            document.getElementById('headerSub').innerText = diff >= 0 ? `è· 3.14 çœè€ƒ ${diff} å¤©` : "å·²è€ƒå®Œ";
            document.getElementById('backTodayBtn').style.display = (dk === formatDate(new Date())) ? 'none' : 'block';
            document.getElementById('phaseContainer').innerHTML = `<div class="phase-card"><div class="phase-title">${phaseInfo.title}</div><div class="phase-desc">${phaseInfo.desc}</div></div>`;

            const s = JSON.parse(localStorage.getItem('hunan_start_times_'+dk)||'{}');
            const e = JSON.parse(localStorage.getItem('hunan_actual_times_'+dk)||'{}');
            const done = JSON.parse(localStorage.getItem('hunan_exam_'+dk)||'[]');
            const notes = JSON.parse(localStorage.getItem('hunan_notes_'+dk)||'{}');

            const listEl = document.getElementById('taskList'); listEl.innerHTML = '';
            tasks.forEach((t, i) => {
                const isD = done.includes(i); const isDur = t.isDuration; const isP = isDur && s[i] && !e[i];
                let btnLbl = isDur ? (isD ? "å®Œæˆ" : (isP ? "è®°ç»“æŸ" : "è®°å¼€å§‹")) : (isD ? "å·²è®°" : "æ ‡è®°");
                let durationTxt = (isDur && s[i] && e[i]) ? `${timeToMins(e[i]) - timeToMins(s[i])}åˆ†é’Ÿ` : "";

                listEl.innerHTML += `
                    <div class="task-item ${isD?'completed':(isP?'in-progress':'')}">
                        <button class="del-day-btn" onclick="removeTaskDaily(${i})">âœ•</button>
                        <div style="display:flex">
                            <div class="status-btn" onclick="handleTaskClick(${i},'${t.t}',${isDur})">${btnLbl}</div>
                            <div style="flex:1">
                                <span style="font-size:0.7rem;color:#999">å‚è€ƒ: ${t.t}</span>
                                <input type="text" class="task-input-title" value="${t.title}" onchange="editTaskDaily(${i}, this.value)">
                                <div class="time-badge-row">
                                    ${s[i]?`<span class="time-badge">å§‹ ${s[i]}</span>`:''}
                                    ${e[i]?`<span class="time-badge">ç»ˆ ${e[i]}</span>`:''}
                                    ${durationTxt?`<span class="duration-badge">${durationTxt}</span>`:''}
                                </div>
                            </div>
                        </div>
                        <textarea class="task-note-area" rows="1" placeholder="å¤ç›˜ç¬”è®°..." onchange="saveNoteDaily(${i}, this.value)">${notes[i]||''}</textarea>
                    </div>`;
            });
            document.getElementById('progressBar').style.width = (tasks.length ? (done.length/tasks.length*100) : 0) + '%';
        }

        // --- å•æ—¥ DIY æ“ä½œ ---
        function addTaskDaily() {
            const dk = formatDate(currentViewDate);
            const tasks = getDailyTaskList(currentViewDate);
            tasks.push({t: "10:00", title: "æ–°ä»»åŠ¡", isDuration: false});
            localStorage.setItem('hunan_daily_tasks_' + dk, JSON.stringify(tasks));
            render();
        }

        function removeTaskDaily(idx) {
            if(!confirm("ç¡®å®šè¦åˆ é™¤ä»Šå¤©è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ(ä¸å½±å“å…¶ä»–å¤©)")) return;
            const dk = formatDate(currentViewDate);
            const tasks = getDailyTaskList(currentViewDate);
            tasks.splice(idx, 1);
            localStorage.setItem('hunan_daily_tasks_' + dk, JSON.stringify(tasks));
            render();
        }

        function editTaskDaily(idx, newTitle) {
            const dk = formatDate(currentViewDate);
            const tasks = getDailyTaskList(currentViewDate);
            tasks[idx].title = newTitle;
            localStorage.setItem('hunan_daily_tasks_' + dk, JSON.stringify(tasks));
            showToast("å•æ—¥ä¿®æ”¹å·²ä¿å­˜");
        }

        function saveNoteDaily(idx, val) {
            const dk = formatDate(currentViewDate);
            let n = JSON.parse(localStorage.getItem('hunan_notes_'+dk)||'{}');
            n[idx] = val;
            localStorage.setItem('hunan_notes_'+dk, JSON.stringify(n));
        }

        // --- è®¡æ—¶æ‰“å¡é€»è¾‘ ---
        function handleTaskClick(idx, plannedTime, isDur) {
            const dk = formatDate(currentViewDate);
            let s = JSON.parse(localStorage.getItem('hunan_start_times_'+dk)||'{}');
            let e = JSON.parse(localStorage.getItem('hunan_actual_times_'+dk)||'{}');
            let done = JSON.parse(localStorage.getItem('hunan_exam_'+dk)||'[]');
            const now = new Date(); const ns = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;

            if (!isDur) {
                if (!s[idx]) {
                    const val = prompt(`æ ‡è®°æ‰“å¡ (å‚è€ƒ: ${plannedTime})`, plannedTime);
                    if (val !== null) { s[idx] = val || plannedTime; done.push(idx); }
                } else { if(confirm("é‡ç½®æ ‡è®°ï¼Ÿ")) { delete s[idx]; done = done.filter(x => x !== idx); } }
            } else {
                if (!s[idx]) {
                    const val = prompt(`è®°å¼€å§‹ (å‚è€ƒ: ${plannedTime})`, plannedTime);
                    if (val !== null) s[idx] = val || plannedTime;
                } else if (!e[idx]) {
                    const val = prompt(`è®°ç»“æŸ (å½“å‰: ${ns})`, ns);
                    if (val !== null) { e[idx] = val || ns; if(!done.includes(idx)) done.push(idx); }
                } else { if(confirm("é‡ç½®è®¡æ—¶ï¼Ÿ")) { delete s[idx]; delete e[idx]; done = done.filter(x => x !== idx); } }
            }
            localStorage.setItem('hunan_start_times_'+dk, JSON.stringify(s));
            localStorage.setItem('hunan_actual_times_'+dk, JSON.stringify(e));
            localStorage.setItem('hunan_exam_'+dk, JSON.stringify(done)); render();
        }

        // --- å…¶ä½™åŠŸèƒ½é€»è¾‘ï¼ˆæ¨¡æ¿è§„åˆ’ã€æ—¥å†ã€å¤‡ä»½ï¼‰ ---
        let editingPlans = [];
        function openPlanModal() { editingPlans = getPlans(); renderPlanEditor(); document.getElementById('planModal').classList.add('active'); }
        function renderPlanEditor() {
            document.getElementById('planEditorBody').innerHTML = editingPlans.map((p, pIdx) => `
                <div class="edit-phase-section">
                    <div style="font-weight:bold;font-size:0.9rem">${p.title}</div>
                    <div style="font-size:0.7rem;color:var(--secondary);margin-bottom:8px">èŒƒå›´: ${p.range[0]}/${p.range[1]}-${p.range[2]}/${p.range[3]}</div>
                    ${p.tasks.map((t, tIdx) => `
                        <div class="edit-task-row">
                            <input type="text" value="${t.t}" class="edit-input" style="width:40px" onchange="editingPlans[${pIdx}].tasks[${tIdx}].t=this.value">
                            <input type="text" value="${t.title}" class="edit-input" style="flex:1" onchange="editingPlans[${pIdx}].tasks[${tIdx}].title=this.value">
                            <label style="font-size:0.7rem"><input type="checkbox" ${t.isDuration?'checked':''} onchange="editingPlans[${pIdx}].tasks[${tIdx}].isDuration=this.checked">è®°æ—¶é•¿</label>
                            <button onclick="editingPlans[${pIdx}].tasks.splice(${tIdx},1);renderPlanEditor()" style="color:red;border:none;background:none">âœ•</button>
                        </div>
                    `).join('')}
                    <button onclick="editingPlans[pIdx].tasks.push({t:'09:00',title:'æ–°ä»»åŠ¡',isDuration:false});renderPlanEditor()" style="font-size:0.7rem;margin-top:5px">+ æ·»åŠ æ¨¡æ¿ä»»åŠ¡</button>
                </div>`).join('');
        }
        function saveAllPlans() { localStorage.setItem('hunan_plan_config', JSON.stringify(editingPlans)); showToast("æ¨¡æ¿å·²æ›´æ–°"); closeModal('planModal'); render(); }
        
        function openHistoryModal() { document.getElementById('historyModal').classList.add('active'); renderCalendarBody(); }
        function renderCalendarBody() {
            const b = document.getElementById('historyContent'); b.innerHTML = '';
            let itr = new Date(START_DATE); const today = new Date(); today.setHours(0,0,0,0);
            while (itr <= EXAM_DATE) {
                const dk = formatDate(itr); const isPast = itr <= today;
                if ((calType === 'past' && isPast) || (calType === 'future' && !isPast)) {
                    const done = JSON.parse(localStorage.getItem('hunan_exam_'+dk)||'[]');
                    b.innerHTML += `<div style="padding:14px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;${dk===formatDate(new Date())?'background:#fff9e6;border-left:5px solid #FFD700;':''}" onclick="viewDate('${dk}')">
                        <span style="font-weight:bold">${itr.getMonth()+1}æœˆ${itr.getDate()}æ—¥</span>
                        <span style="font-size:0.75rem;color:${done.length>0?'var(--success)':'#ccc'}">${done.length}é¡¹å·²æˆ</span>
                    </div>`;
                }
                itr.setDate(itr.getDate()+1);
            }
        }
        function switchCalendar(t) { calType=t; document.getElementById('tabPast').className=t==='past'?'tab-btn active':'tab-btn'; document.getElementById('tabFuture').className=t==='future'?'tab-btn active':'tab-btn'; renderCalendarBody(); }
        function viewDate(k) { currentViewDate = new Date(k); render(); closeModal('historyModal'); }
        function changeDay(o) { currentViewDate.setDate(currentViewDate.getDate()+o); render(); }
        function goToToday() { currentViewDate = new Date(); render(); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function showSettings() { document.getElementById('settingsModal').classList.add('active'); }
        function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1000); }
        function exportData() {
            let d={}; for(let i=0;i<localStorage.length;i++){ let k=localStorage.key(i); if(k.startsWith('hunan_')) d[k]=localStorage.getItem(k); }
            const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(d)],{type:'application/json'})); a.download=`çœè€ƒå…¨é‡è®°å½•å¤‡ä»½_${formatDate(new Date())}.json`; a.click();
        }
        function importData(i) { const r=new FileReader(); r.onload=e=>{ try { const d=JSON.parse(e.target.result); for(let k in d) localStorage.setItem(k,d[k]); location.reload(); } catch(err){alert("å¯¼å…¥å¤±è´¥")} }; r.readAsText(i.files[0]); }
        function resetAllData() { if(confirm("ç¡®å®šæ¸…ç©ºï¼Ÿ")) { localStorage.clear(); location.reload(); } }

        render();
    </script>
</body>
</html>
